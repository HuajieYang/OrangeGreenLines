---
title: "Corridor_level_paper"
author: "Huajie Yang"
date: "1/31/2020"
output: html_document
---

<style>
    body .main-container {
        max-width: 1100px;
    }
</style>

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(scipen=100)
options(digits=3)

if (!require("pacman")) {install.packages("pacman"); library(pacman)}
p_load(dplyr, lubridate, ggplot2, stargazer, stringr, scales, gridExtra, tidyr, foreign)

```


# Abstract
In the context of increasing daily traffic congestion and auto dependence, light rail transit (LRT) has been suggested as an effective means to reduce auto dependence and relieve traffic congestion. Between 1999 and 2017, nationwide vehicle revenue hours of LRT service has increased from 3.1 million to 7.5 million (NTD, 2000, 2018). There is a growing body of literature investigating the effects of LRT on transit ridership and traffic congestion, but so far previous research has failed to systematically evaluate the short- and long-term effects due to lack of consistent high resolution historical data. Most existing studies have to convert annual average daily traffic as approximate measurements of traffic congestion (Bhattacharjee and Goetz, 2012; Ewing et al., 2014), but such measurements cannot reveal daily or monthly variation in traffic congestion. Emerging high resolution archival transportation data provide a potential opportunity to tackle the problem (Giuliano et al., 2015).  

This study utilizes transit boarding data and high resolution historical traffic information from archival databases and iPeMS to comprehensively investigate the short- and long-term effects of LRT at the corridor level with case studies of two LRT lines in Portland, OR region. Using a quasi-experiment design, we estimate the effects of LRT on transit ridership and traffic delay and reliability with high-resolution transit and travel time data over a longer time period than existing studies.  For each LRT line, we first compare transit ridership and traffic condition before and after its opening and then estimate difference-in-difference regression models to examine its effects. Both LRT lines increased transit ridership in the short- and long-term, and relieved traffic congestion in the short-term, while having no significant effect on traffic congestion in the long-term due to induced traffic demand. The effects of LRT varied by LRT lines because of local land use and transportation system. In addition to contributing to the literature on the effects of transit, this study demonstrates how high-resolution archival transportation data enable analyses that were previously impossible. The growing availability of transportation data of high temporal and spatial resolution over a long time period provides a unique opportunity to evaluate the effects of transportation policies and projects like LRT and their evolution, which helps to explain the seemingly conflicting empirical results in existing studies and therefore provides an improved understanding of the effects. 

# Introduction 

# Data 

# Study area and Methodology 
Study area section describes the impacted roadways. 

Explain why use travel and travel time reliability. 
# Analysis 

## Transit ridership 
A net increase in transit ridership is a necessary condition for impacts on traffic congestion, thus I conduct four comparisons to examine the impacts on transit ridership within the experimental corridor. 


### Orange Line & Green Line
First, the first analysis compare average weekday boardings at all bus and rail stops within the experimental and control corridors before and after the operation of the Orange Line. As shown in the Figure ***, the dashed line indicates the date when the Orange Line started operation. After the opening of the Orange Line, boardings within the experimental corridor sharply increased while boardings within the control corridor decreased slightly. Then, I decompose the ridership within the experimental corridor. The average weekday ridership of Orange line is about a little more than 5000. It indicates the majority of increase in ridership is from the Orange Line. These evidences show that the MAX Orange Line has made a contribute to the increased transit ridership. The results show that there is a approximate 7,000 increase in the average weekday boardings. 

?Transfer analysis， get off analysis, analysis the get off at bus stops close the rail stations.? 

##### average weekday boardings
```{r}
# Load and organize transit ridership and stop locations data 
# Extract weekday boardings within the experimental and control corridors 
# # Transit ridership data ====
# # Ridership dataset does not provide streetcar ridership 
# ridership <- read.csv("data/Passenger Census Dump - All.csv", as.is=TRUE)
# 
# month_df <- data.frame(month_num=c(1:12),
#                        month_char=c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"))
# 
# Weekday ridership 
# ridership_w <- ridership %>%
#                 filter(SERVICE_KEY=="W") %>%
#                 mutate(SUMMARY_BEGIN_DATE=as.character(SUMMARY_BEGIN_DATE),
#                        YEAR=as.numeric(substr(SUMMARY_BEGIN_DATE, 6,9)),
#                        month_char=substr(SUMMARY_BEGIN_DATE, 3,5),
#                        DAY=as.numeric(substr(SUMMARY_BEGIN_DATE, 1,2)),
#                        TIME=substr(SUMMARY_BEGIN_DATE, 11, 18),
#                        rt_dir_stopdesc=paste(ROUTE_NUMBER, DIRECTION, PUBLIC_LOCATION_DESCRIPTION, sep="_"),
#                        hm_char=substr(STOP_TIME, 1, 1),
#                        AM_PM=substr(STOP_TIME, nchar(STOP_TIME)-1, nchar(STOP_TIME)),
#                        AM_Peak=ifelse((hm_char %in% c(6, 7, 8, 9))&AM_PM=="AM", "AM Peak", "Non AM Peak"),
#                        PM_Peak=ifelse((hm_char %in% c(4, 5, 6, 7))&AM_PM=="PM", "PM Peak", "Non PM Peak"),
#                        AM_PM_Peak=ifelse(AM_Peak=="AM Peak"|PM_Peak=="PM Peak", "Peak Periods", "Non Peak Periods")
#                 )  %>%
#                 left_join(month_df) %>%
#                 mutate(date=ymd(paste(YEAR, month_num, DAY, sep="-")))
# 
# save(ridership_w, file = "output/intermediate/ridership_w.RData")

load("~/OrangeGreenLines/output/intermediate/ridership_w.RData")

ridership_w <- ridership_w %>%
               filter(date <= "2018-06-03")

# Use bus stops within corridor (first version of corridor: corridor areas are different in the first and second versions)
# # Load  experimental and control stops GIS bus stop data ====
# control_busstops <-  read.dbf("data/GIS/Control_Corridor_BusStops.dbf", as.is=TRUE)
# experimental_busstops <- read.dbf("data/GIS/Experimental_Corridor_BusStops.dbf", as.is=TRUE)
# 
# # RTE 200 is the MAX Green Line
# control_busstops <- control_busstops %>%
#                     mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))
# 
# # 194, 195, 196 are streetcar; no streetcar ridership in ridership dataset
# # RTE 290 is the MAX Orange Line
# experimental_busstops <- experimental_busstops %>%
#                          filter(!(RTE %in% c("194", "195", "196"))) %>%
#                          mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))
# 
# # extract ridership of control stops from ridership data
# ridership_w_control <- ridership_w %>%
#                           filter(rt_dir_stopdesc %in% control_busstops$rt_dir_stopdesc)
# 
# # all rt_dir_stopdesc are available from ridership dataset
# # sort(unique(ridership_w_rt_control$rt_dir_stopdesc))==sort(unique(control_busstops$rt_dir_stopdesc))
# 
# ridership_w_experimental <- ridership_w %>%
#                                filter(rt_dir_stopdesc %in% experimental_busstops$rt_dir_stopdesc)
# 
# # sort(unique(ridership_w_rt_experimental$rt_dir_stopdesc))==sort(unique(experimental_busstops$rt_dir_stopdesc))
# # There is one stops that do not appear in ridership dataset: SE McLoughlin & Park Ave is not in ridership dataset
# # setdiff(sort(unique(experimental_busstops$rt_dir_stopdesc)), sort(unique(ridership_w_rt_experimental$rt_dir_stopdesc)))

# Use bus stops within corridor1 (second version of corridor)
# Load GIS bus stop data of control corridor and experimental corridor 
control_corridor1_busstops <-  read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Control_corridor1_busstops.dbf", as.is=TRUE) 
experimental_corridor1_busstops <- read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Experimental_corridor1_busstops.dbf", as.is=TRUE) 

# RTE 200 is the MAX Green Line
control_corridor1_busstops <- control_corridor1_busstops %>%
                    mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

# 194, 195, 196 are streetcar; no streetcar ridership in ridership dataset
# RTE 290 is the MAX Orange Line
experimental_corridor1_busstops <- experimental_corridor1_busstops %>%
                          filter(!(RTE %in% c("194", "195", "196"))) %>%
                          mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

# extract ridership of control stops from ridership data 
ridership_w_rt_control_corridor1 <- ridership_w %>%
                                      filter(rt_dir_stopdesc %in% control_corridor1_busstops$rt_dir_stopdesc)

# all rt_dir_stopdesc are available from ridership dataset
# sort(unique(ridership_w_rt_control_corridor1$rt_dir_stopdesc))==sort(unique(control_corridor1_busstops$rt_dir_stopdesc))
 
ridership_w_rt_experimental_corridorl <- ridership_w %>%
                                          filter(rt_dir_stopdesc %in% experimental_corridor1_busstops$rt_dir_stopdesc)

# There are three stops do not show in riderhship dataset:  "291_0_SE McLoughlin & Park Ave", "33_1_SE Jefferson & Main", "34_1_SE Jefferson & Main" 
# setdiff(sort(unique(experimental_corridor1_busstops$rt_dir_stopdesc)), sort(unique(ridership_w_rt_experimental_corridorl$rt_dir_stopdesc)))

# Avoid recoding 
# Use data from Control_corridor1_busstops.dbf & Experimental_corridor1_busstops.dbf
ridership_w_control <- ridership_w_rt_control_corridor1
ridership_w_experimental <- ridership_w_rt_experimental_corridorl
```

```{r}
# Route 2  provides ridership from 2018-09-02 to present
# 291-Orange Night Bus provides ridership from 2015-09-13 to present 
# 290 MAX Orange Line provides ridership from 2015-09-13 to present 
ridership_w_experimental_summary1 <- ridership_w_experimental %>%
                                      filter(date >= "2012-09-02") %>% 
                                      group_by(ROUTE_NUMBER, date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

ridership_w_experimental_summary2 <- ridership_w_experimental %>%
                                      filter(!(ROUTE_NUMBER %in% c(2, 291)), date >= "2012-09-02") %>% 
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

# Route 2 only provide ridership from 2018-09-02 to present
# Route 73 only provide ridership from 2016-09-04 to present 
# Route 74 only provide ridership form 2018-03-04
# Ridership of RTE 200 MAX Green Line is from 2012-09-02 to present 
ridership_w_control_summary1 <- ridership_w_control %>%
  filter(date >= "2012-09-02") %>%
  group_by(ROUTE_NUMBER, date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

ridership_w_control_summary2 <- ridership_w_control %>%
  filter(!(ROUTE_NUMBER %in% c(2, 73, 74)), date >= "2012-09-02") %>%
  group_by(date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

# Orangeize ridership dataframe for DID regression 
ridership_w_experimental_summary2 <- ridership_w_experimental_summary2 %>%
  mutate(Group="Experimental corridor")

ridership_w_control_summary2 <- ridership_w_control_summary2 %>%
  mutate(Group="Control corridor")

rs_did_df <- rbind(ridership_w_experimental_summary2, ridership_w_control_summary2) %>% 
             mutate(Before_after=ifelse(date >= "2015-09-13", 1, 0),
                    Year_1st=ifelse(date>="2015-09-13" & date <= "2016-06-05", 1, 0),
                    Year_2nd=ifelse(date>="2016-09-04" & date <= "2017-06-04", 1, 0),
                    Year_3rd=ifelse(date>="2017-09-03" & date <= "2018-06-03", 1, 0))

p_bd_ec_cc <- ggplot(rs_did_df, aes(date, ONES_SUM), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
  geom_point(aes(colour=Group), size=0.75) + 
  ggtitle("Boardings at transit stops within \n the experimental/control corridors") +
  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=10)) + ylim(3000, 17000)
p_bd_ec_cc
```

```{r}
# ridership of Orange Line and Existing transit data.frame 
ridership_w_experimental_summary3 <- ridership_w_experimental %>%
                                      filter(ROUTE_NUMBER %in% c(290)) %>% # Route 290 MAX Orange Line  
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup() 

ridership_w_experimental_summary3 <- ridership_w_experimental_summary3 %>%
                                     mutate(Group="MAX Orange Line")

# Existing bus ridership within experimental corridor 
ridership_w_experimental_summary4 <- ridership_w_experimental %>%
                                      filter(!(ROUTE_NUMBER %in% c(2, 290, 291)), date >= "2012-09-02") %>% 
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

ridership_w_experimental_summary4 <- ridership_w_experimental_summary4 %>%
                                     mutate(Group="Existing Transit")

rs_ol_et <- rbind(ridership_w_experimental_summary3, ridership_w_experimental_summary4)

# plot of ridership of MAX Orange Line and Exisitng transit data.frame 
p_rs_ol_et <- ggplot(rs_ol_et, aes(date, ONES_SUM, color=Group), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
  geom_point(size=0.75) + scale_color_manual(values=c("#A569BD", "#F8C471")) + 
  ggtitle("Boardings at MAX Orange Line and exisitng transit \n stops within experimental corridor") +
  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + ylim(4000, 7000) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=10))  

p_rs_ol_et
```

##### Traverse bus lines 
Then, this study compares ridership of bus lines that run through the the experimental and control corridors. In the experimental corridor, these lines connect the southeast Portland with downtown Portland and therefore provide alternative option to the Orange Line. Shown in the Figure ***, these lines cross the screenlines. Results show that total bidirectional ridership at all stations of these lines within experimental corridor decreased at a larger rate compared to corresponding bus lines within the control corridor after the operation of the Orange Line. The results seems to indicate that a small portion of increase in transit ridership switch form the existing bus service. 

```{r}
# Routes 19, 30, 70, 291 cross the screenline  
ridership_experimental2  <- ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(19, 30, 70, 291), date >= "2012-09-02")  %>% 
  group_by(date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(Group="Experimental corridor")

# ggplot(ridership_experimental2, aes(date, ONES_SUM)) + geom_point() + geom_smooth()  +
#  ggtitle("average total weekday ridership of east–west \n transit lines within the experimental corridor (exclude Orange Line")

# Control corridor  
# East-west routes: 9, 10, 14, 17, 
# North-south: 71, 72, 75, 
# Route 66 west part/short 
# 200 MAX Green Line 

# East-west route 9, 17 cross the screenliens 
ridership_control  <- ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(9, 17), date >= "2012-09-02")  %>% 
  group_by(date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Group="Control corridor")

# ggplot(ridership_control, aes(date, ONES_SUM)) + geom_point() + geom_smooth() + ylim (11000, 20000) +
#  ggtitle("average total weekday ridership of east–west \n transit lines within the control corridor")

buslines_exp_con <- rbind(ridership_experimental2, ridership_control)

ggplot(buslines_exp_con, aes(date, ONES_SUM), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
  geom_point(aes(colour=Group), size=0.75) + 
  ggtitle("Boardings of traverse bus lines within \n the experimental/control corridors") +
  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=10)) # + ylim(3000, 17000)

```

##### Ridership of traverse bus lines during peak periods 
Only drivers switching from driving to transit during peak periods can relieve traffic congestion, I analyzed the weekday peak-period bidirectional ridership of the Orange Line and existing bus lines that traverse the same screenline. Shown in the Figure ***, ridership of the existing parallel bus lines decreased slightly while the ridership of the Orange Line is much larger than the decreased ridership of the existing parallel bus lines. The combined effect shows that there is an overall increase in transit ridership within the experimental corridor. 

```{r}

ridership_rt_experimental_peak2  <-  ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(19, 30, 70, 290, 291), date >= "2012-09-02", AM_PM_Peak=="Peak Periods")  %>% 
  mutate(Transit=ifelse(ROUTE_NUMBER==290, "MAX Orange Line", "Existing parallel bus lines"))  %>% 
  group_by(Transit, date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

 ggplot(ridership_rt_experimental_peak2, aes(date, ONES_SUM, color=Transit), group=Transit) +       geom_smooth(aes(linetype=Transit), color="#909497") +
                  geom_point(size=0.75) + scale_color_manual(values=c("#A569BD", "#F8C471")) + 
                  ggtitle("Peak periods bidirectional boardings of MAX \n Orange Line and traverse bus lines") +
                  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=9),
                        legend.position="bottom",
                        legend.title=element_text(family="Times",size=9, face="bold"),
                        legend.text=element_text(family="Times",size=10))  #+ ylim(4000, 14000) 
```

##### Boardings and alightings at specific bus stops within a quarter-mile walking radius of MAX Orange Line stations.
Lastly, I compared boardings and alightings at bus stops that are within a quarter-mile network distance of Orange Line stops before and after the operation of the Orange Line. Shown in the Figure ***, boardings and alightings both largely increased after the operation of the Orange Line. Due to the limitation of data, it is hard to figure out whether such increases result from new ridership or a switch from the existing riderhship. 

```{r}
bus_stops_quarter_mile <-  read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Bus_stops_quarter_mile_withoutMAX_SC.dbf", as.is=TRUE) 

bus_stops_quarter_mile <- bus_stops_quarter_mile %>%
  mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))  %>%
  select(RTE, DIR, LOCATION,  rt_dir_stopdesc) # , join_STATI

ridership_bus_stops_quarter_mile <- ridership_w %>%
  filter(rt_dir_stopdesc %in% bus_stops_quarter_mile$rt_dir_stopdesc) %>%
  left_join(bus_stops_quarter_mile)  


ridership_bus_stops_quarter_mile_summary1 <- ridership_bus_stops_quarter_mile %>%
  filter(!(ROUTE_NUMBER %in% c(2)), date >= "2012-09-02") %>%
  group_by(date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE),
            OFFS_SUM=sum(OFFS, na.rm = TRUE))

ridership_bus_stops_quarter_mile_summary1_long <- gather(ridership_bus_stops_quarter_mile_summary1, Ridership, Amount, ONES_SUM:OFFS_SUM, factor_key=TRUE) %>%
                                                  mutate(Ridership=ifelse(Ridership=="ONES_SUM", "Boardings", "Alightings"))

ggplot(ridership_bus_stops_quarter_mile_summary1_long, aes(date, Amount, color=Ridership), group=Ridership) + geom_smooth() + 
  geom_point(size=0.75) +ggtitle("Boardings and alightings at bus stops within a quarter-mile \n network distance of MAX Orange Line stations") +
  labs(x="Date", y="Amount") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=8)) 
```

In summary, the results of these analyses show that there has been a net increase in transit ridership in the experimental corridor after the opening of the Orange Line. ?write more? 



## Traffic congestion 
This study focuses on the impacts on traffic congestion and thus I only examine the changes in travel speed during weekday AM and PM peak periods. The peak periods are consistent with Portland metropolitan area Travel Demand Modeling. The AM peak is 7 to 10 AM, and the PM peak is 4 to 7 PM. 

### Orange Line 
An important goal of the MAX Orange Line is to relieve traffic congestion on the parallel roadways, and therefore I investigate the impacts on traffic congestion on the SE McLoughlin Blvd. The SE McLoughlin Blvd is almost parallel to the MAX Orange Line and carries very large daily traffic volumes. The impacts are expected to concentrate within the experimental segment of SE McLoughlin Blvd. Shown in Figure ***, the experimental segment is the part within the experimental corridor and the control segment is the part within the control corridor. 

To examine the impact of the Orange Line on traffic congestion, this study examines travel speed and its reliability. First, I Investigate the changes in average speed on experimental and control roadways by peak period (AM and PM peak) and directions (inbound to/outbound from CBD), shown in Figure ***. Before the operation of the MAX Orange Line, the trend of average peak period travel speed on experimental and control roadway segments are the same, which meets the assumption of DID approach. After the operation of the MAX Orange Line, both inbound to CBD and outbound from CBD travel speed on control roadway segment for AM and PM peak periods kept almost constant, while both inbound to and outbound from CBD average peak periods travel speed on the experimental segment overall increased. The growth rate of outbound from CBD speed for AM peak period is largest and followed by inbound to CBD speed for PM peak.
```{r}
# Prepare data 
# source("code/OL_prepare_data.R")
 load("output/intermediate/data_combined_day_wdpeak.RData")

 data_combined_day_wdpeak <- data_combined_day_wdpeak %>%
                             filter(DDV_his_em_avg > 0)  

 data_combined_day_wdpeak_ma <- data_combined_day_wdpeak %>%
                               select(roadway, date, AM_PM, before_after, Speed=AvgSpeed) %>%
                               filter(roadway %in% c("McLoughlin_S", "Powell_E", "McLoughlin_N", "Powell_W")) %>%
                               mutate(Direction=ifelse(roadway %in% c("McLoughlin_S", "Powell_E"), "Outbound from CBD", "Inbound to CBD"),
                                      Group=ifelse(roadway %in% c("Powell_W", "Powell_E"), "Control (Powell Blvd)", 
                                                                  "Experimental (McLoughlin Blvd)"))

  p_sp_ma_4g <- ggplot(data=data_combined_day_wdpeak_ma, aes(x=date, y=Speed, group=Group, colour=Group)) +
                  geom_point() + geom_smooth(aes(linetype=Group), colour="yellow", size=0.75) + 
                  geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) +  ylim(0, 50) + ggtitle("Weekday peak periods speed")+
                  labs(x="Date", y="Speed (mph)") + facet_grid(AM_PM ~ Direction) +
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=12),
                        legend.position="bottom",
                        legend.title=element_text(family="Times",size=12, face="bold"),
                        legend.text=element_text(family="Times",size=10),
                        strip.text = element_text(size = 10)
                  ) 
  
  p_sp_ma_4g
```


Table *** shows the descriptive analysis of speed on control and experimental roadway segments by peak periods and directions. Comparisons are conducted between before and after periods for each case. Of the four experimental comparison cases, average speed increased in three cases, all of which are statistically significant; in the remaining case (PM peak outbound from CBD), average speed decreased by 0.7 mph, which is smaller than the decrease rate (-2.2 mph) of corresponding control case. The results of the descriptive analysis indicate that the MAX Orange Line has had a relief impact on the experimental roadway segment.


```{r}
# # Calculate average speed and standard deviation 
# data_combined_day_wdpeak_ma %>%
#               group_by(roadway, AM_PM, before_after) %>%
#               summarise(Speed_avg=mean(Speed, na.rm=TRUE),
#                          Speed_sd=sd(Speed, na.rm=TRUE))
# 
# # T-test 
# # Major Arterials 
# # AM Peak period
# # AM inward CBD: experiment 
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: experiment 
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM inward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM Peak period
# # PM inward CBD: experiment 
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: experiment 
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM inward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())

# Insert before after table 
knitr::include_graphics("Table picture.png")
```

A one-group pre-treatment/post-treatment comparison of the experimental roadway segment is weak because it lacks a control group and it may be in doubt to attribute the changes to the operation of the Orange Line. To circumvent this weakness, this study, therefore, utilized a difference-in-difference (DID) approach. The following table shows the results of the DID regression model. Of the four models, compared to the control roadway segment and pre-operation period, the coefficients of DID estimators indicate a significant relative increase in the speed of the experimental roadway in all cases, indicating that the Orange Line has a relief effect on traffic congestion on the experimental segment. The size of impacts is different across the AM/PM peak periods and inbound to/outbound from CBD directions. 

```{r}
# Base models
sp_amo_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group,
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="AM"))

sp_ami_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="AM"))

sp_pmo_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="PM"))

sp_pmi_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                      data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="PM"))

stargazer(sp_amo_day_ma, sp_ami_day_ma, sp_pmo_day_ma, sp_pmi_day_ma, 
              column.labels = c("AM Outbound", "AM Inbound", "PM Outbound",  "PM Inbound"),
              dep.var.labels=c("Travel Speed"),
              covariate.labels=c("Time Period (after = 1)", "Group (experimental group = 1)", "Time Period × Group"),
              type="text", title="Orange Line speed base models", keep.stat=c("n", "rsq", "adj.rsq", "ser")) 

```

Using the results of the DID models, the following figure displays the changes in average peak period travel speed from before to after (Time = 1) the operation of the Orange Line for both the experimental and control roadway segments by directions and peak periods. The "counterfactual" line shows what might have happened in the absence of the operation of the Orange Line, assuming the change in travel speed on the experimental roadway segment would be the same as the change in travel speed on the control roadway segment. As shown in Figure ***, travel speed on the experimental roadway segment for after period is higher than that in the counterfactual scenario for after period. This reveals that the operation of the Orange Line has had a relief effect on travel speed on the experimental roadway segment.

```{r}
# Plots 
# Plot base DID models ====
# Specify base model matrix 
bm_mx <- matrix(c(1, 1, 1, 1, 1, 1,
                  0, 1, 0, 1, 0, 1,
                  0, 0, 1, 1, 1, 1, 
                  0, 0, 0, 1, 0, 0), nrow=4, byrow=TRUE)

# major arterial speed base models
sp_amo_day_ma_coef_mx <- t(as.matrix(summary(sp_amo_day_ma)$coefficient[, 1]))
sp_ami_day_ma_coef_mx <- t(as.matrix(summary(sp_ami_day_ma)$coefficient[, 1]))
sp_pmo_day_ma_coef_mx <- t(as.matrix(summary(sp_pmo_day_ma)$coefficient[, 1]))
sp_pmi_day_ma_coef_mx <- t(as.matrix(summary(sp_pmi_day_ma)$coefficient[, 1]))

sp_did_ma_df <- data.frame(Group=rep(c("Control", "Treated", "Counterfactual"), each=2), 
                           Before_after=rep(c("before", "after"), 3),
                           sp_amo_day_ma_speed=as.numeric(sp_amo_day_ma_coef_mx %*% bm_mx),
                           sp_ami_day_ma_speed=as.numeric(sp_ami_day_ma_coef_mx %*% bm_mx),
                           sp_pmo_day_ma_speed=as.numeric(sp_pmo_day_ma_coef_mx %*% bm_mx),
                           sp_pmi_day_ma_speed=as.numeric(sp_pmi_day_ma_coef_mx %*% bm_mx)) 


sp_did_ma_df$Before_after <- relevel(sp_did_ma_df$Before_after, "before")

sp_amo_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_amo_day_ma_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Outbound from CBD")

sp_ami_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_ami_day_ma_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Inbound to CBD")

sp_pmo_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_pmo_day_ma_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Outbound from CBD")

sp_pmi_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_pmi_day_ma_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Inbound to CBD")

sp_did_ma_df_long <- rbind(sp_amo_day_ma_speed_df, sp_ami_day_ma_speed_df, sp_pmo_day_ma_speed_df, sp_pmi_day_ma_speed_df) %>%
                     mutate(Scenario=paste(AM_PM, Direction, sep=" "),
                            Before_after=ifelse(Before_after=="after", 1, 0))

# Plot of two peak periods and two directions 
p_sp_did_ma_4g <-  ggplot(sp_did_ma_df_long, aes(x=Before_after, y=Speed, group=Group)) +
                    geom_line(aes(color=Group)) + geom_point() + ylab("Speed (MPH)") + 
                    xlab("Time (after=1)")  + scale_x_continuous(breaks=c(0, 1)) + 
                    ggtitle("DID models for weekday peak periods speed") +  facet_grid(AM_PM ~ Direction) + 
                    theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                          axis.text = element_text(family="Times",size=8),
                          axis.title=element_text(family="Times",size=9),
                          legend.position="bottom",
                          legend.title=element_text(family="Times",size=9, face="bold"),
                          legend.text=element_text(family="Times",size=8)
                    ) 

p_sp_did_ma_4g

ggsave(file="output/plots/OL DID plots/p_sp_did_ma_4g.png", p_sp_did_ma_4g, width=5, heigh=4)
```

To investigate the changes in peak periods travel speed over time, DID regression models with multiple time periods are estimated. I creat year dummies for all years (1st year: 09/12/2015 - 09/11/2016; 2nd year: 09/12/2016 - 09/11/2017; 2nd year: 09/12/2017 - 09/11/2018). The following table shows the results of the DID regression models. Of the four models, the coefficients of DID estimators indicate significant relative increase in the speed of the experiment roadway in most cases. Only the DID estimator for the first year PM peak outbound from CBD is negative, but it is not statistically significant. The results reveal that the Orange Line has had a positive impact on average peak periods travel speed on SE McLoughlin Blvd.

```{r}
# Multiple time periods models 
sp_amo_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="AM"))

sp_ami_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="AM"))

sp_pmo_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="PM"))

sp_pmi_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="PM"))

stargazer(sp_amo_day_ma_3yd_int, sp_ami_day_ma_3yd_int, sp_pmo_day_ma_3yd_int, sp_pmi_day_ma_3yd_int, 
          column.labels = c("AM Outbound", "AM Inbound", "PM Outbound",  "PM Inbound"),
          dep.var.labels=c("Travel Speed"),
          type="text", title="Orange Line speed DID with multiple time priods", keep.stat=c("n", "rsq", "adj.rsq", "ser"))
```

Using the results of DID models with multiple time periods, the following figure shows predicted average weekday peak periods speed over time. The dashed horizontal lines indicate the average treated impacts of corresponding cases. The line plot reveals the nonlinear effect of the Orange Line on traffic. Overall, the size of the effects increased over time. The size of yearly effects is different for AM/PM peak periods and inbound to and outbound from CBD directions.

```{r}
# Plot multiple time priods results 
# plot DID models with three year dummy variables 
mt_3yd_mx <- matrix(c(rep(1, 4),
                      rep(1, 4),
                      0, 1, 0, 0, 
                      0, 0, 1, 0,
                      0, 0, 0, 1,
                      0, 1, 0, 0, 
                      0, 0, 1, 0,
                      0, 0, 0, 1), nrow=8, byrow=TRUE)

# AM outbound 
sp_amo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_amo_day_ma_3yd_int)$coefficient[, 1]))
sp_amo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_amo_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_amo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_amo_day_ma_3yd_int)$coefficient[, 1]))
# ddv_amo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_amo_day_ma_3yd_int)$coefficient[, 2]))^2

amo_day_ma_3yd_int_df <- data.frame(AM_PM="AM peak",
                                   Direction="Outbound from CBD",
                                   TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                    levels=c("Before", "1st year", "2nd year", "3rd year")),
                                   Speed=as.numeric(sp_amo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   Speed_se=as.numeric(sqrt(sp_amo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                   # DDV=as.numeric(ddv_amo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   # DDV_se=as.numeric(sqrt(ddv_amo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# AM inbound 
sp_ami_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_ami_day_ma_3yd_int)$coefficient[, 1]))
sp_ami_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_ami_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_ami_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_ami_day_ma_3yd_int)$coefficient[, 1]))
# ddv_ami_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_ami_day_ma_3yd_int)$coefficient[, 2]))^2

ami_day_ma_3yd_int_df <- data.frame(AM_PM="AM peak",
                                   Direction="Inbound to CBD",
                                   TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                    levels=c("Before", "1st year", "2nd year", "3rd year")),
                                   Speed=as.numeric(sp_ami_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   Speed_se=as.numeric(sqrt(sp_ami_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                   # DDV=as.numeric(ddv_ami_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   # DDV_se=as.numeric(sqrt(ddv_ami_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# PM outbound 
sp_pmo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_pmo_day_ma_3yd_int)$coefficient[, 1]))
sp_pmo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_pmo_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_pmo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_pmo_day_ma_3yd_int)$coefficient[, 1]))
# ddv_pmo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_pmo_day_ma_3yd_int)$coefficient[, 2]))^2

pmo_day_ma_3yd_int_df <- data.frame(AM_PM="PM peak",
                                    Direction="Outbound from CBD",
                                    TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                     levels=c("Before", "1st year", "2nd year", "3rd year")),
                                    Speed=as.numeric(sp_pmo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    Speed_se=as.numeric(sqrt(sp_pmo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                    # DDV=as.numeric(ddv_pmo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    # DDV_se=as.numeric(sqrt(ddv_pmo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# PM inbound 
sp_pmi_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_pmi_day_ma_3yd_int)$coefficient[, 1]))
sp_pmi_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_pmi_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_pmi_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_pmi_day_ma_3yd_int)$coefficient[, 1]))
# ddv_pmi_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_pmi_day_ma_3yd_int)$coefficient[, 2]))^2

pmi_day_ma_3yd_int_df <- data.frame(AM_PM="PM peak",
                                    Direction="Inbound to CBD",
                                    TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                     levels=c("Before", "1st year", "2nd year", "3rd year")),
                                    Speed=as.numeric(sp_pmi_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    Speed_se=as.numeric(sqrt(sp_pmi_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                    # DDV=as.numeric(ddv_pmi_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    # DDV_se=as.numeric(sqrt(ddv_pmi_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

did_day_ma_3yd_int_df <- rbind(amo_day_ma_3yd_int_df, ami_day_ma_3yd_int_df, pmo_day_ma_3yd_int_df, pmi_day_ma_3yd_int_df)%>%
                         mutate(Group=paste(AM_PM, Direction, sep=" "))

# Plot of two peak periods and two directions
p_sp_did_ma_3yd_int_4g <-  ggplot(did_day_ma_3yd_int_df, aes(x=TreatTime, y=Speed, group=Group, color=Group)) +
  geom_line() + geom_point() + 
  geom_errorbar(aes(ymin=Speed-1.96*Speed_se, ymax=Speed+1.96*Speed_se, width=.1)) + # , position=position_dodge(0.05)
  geom_hline(yintercept = c(26.9, 35.6, 34.4, 28.0), color=c('#999999','#E69F00', "#82E0AA", "#85C1E9"), linetype="dashed")+
  xlab("Treatment time periods") + ylab("Speed (MPH)") + ylim(20, 40) +
  ggtitle("Predicted average weekday peak periods speed") + scale_color_manual(values=c('#999999','#E69F00', "#82E0AA", "#85C1E9")) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=8)
  ) + guides(colour =guide_legend(ncol=2))

p_sp_did_ma_3yd_int_4g

ggsave(file="output/plots/OL DID plots/p_sp_did_ma_3yd_int_4g.png", p_sp_did_ma_3yd_int_4g, width=5, heigh=4)
```

### Green Line 







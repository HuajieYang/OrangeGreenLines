---
title: "Corridor_level_paper"
author: "Huajie Yang"
date: "1/31/2020"
output:
  bookdown::html_document2: default
  bookdown::pdf_document2: default
---

<style>
    body .main-container {
        max-width: 1100px;
    }
</style>

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(scipen=100)
options(digits=3)

if (!require("pacman")) {install.packages("pacman"); library(pacman)}
p_load(dplyr, lubridate, ggplot2, stargazer, stringr, scales, gridExtra, tidyr, foreign)

```


# Abstract
In the context of increasing daily traffic congestion and auto dependence, light rail transit (LRT) has been suggested as an effective means to reduce auto dependence and relieve traffic congestion. Between 1999 and 2017, nationwide vehicle revenue hours of LRT service has increased from 3.1 million to 7.5 million (NTD, 2000, 2018). There is a growing body of literature investigating the effects of LRT on transit ridership and traffic congestion, but so far previous research has failed to systematically evaluate the short- and long-term effects due to lack of consistent high resolution historical data. Most existing studies have to convert annual average daily traffic as approximate measurements of traffic congestion (Bhattacharjee and Goetz, 2012; Ewing et al., 2014), but such measurements cannot reveal daily or monthly variation in traffic congestion. Emerging high resolution archival transportation data provide a potential opportunity to tackle the problem (Giuliano et al., 2015).  

This study utilizes transit boarding data and high resolution historical traffic information from archival databases and iPeMS to comprehensively investigate the short- and long-term effects of LRT at the corridor level with case studies of two LRT lines in Portland, OR region. Using a quasi-experiment design, we estimate the effects of LRT on transit ridership and traffic delay and reliability with high-resolution transit and travel time data over a longer time period than existing studies.  For each LRT line, we first compare transit ridership and traffic condition before and after its opening and then estimate difference-in-difference regression models to examine its effects. Both LRT lines increased transit ridership in the short- and long-term, and relieved traffic congestion in the short-term, while having no significant effect on traffic congestion in the long-term due to induced traffic demand. The effects of LRT varied by LRT lines because of local land use and transportation system. In addition to contributing to the literature on the effects of transit, this study demonstrates how high-resolution archival transportation data enable analyses that were previously impossible. The growing availability of transportation data of high temporal and spatial resolution over a long time period provides a unique opportunity to evaluate the effects of transportation policies and projects like LRT and their evolution, which helps to explain the seemingly conflicting empirical results in existing studies and therefore provides an improved understanding of the effects. 

# Introduction 

# Data 

# Study area and Methodology 
Study area section describes the impacted roadways. 

Explain why use travel and travel time reliability. 
# Analysis 

## Transit ridership 
A net increase in transit ridership is a necessary condition for impacts on traffic congestion, thus I conduct four comparisons to examine the impacts on transit ridership within the experimental corridor. 

##### average weekday boardings
First, this study analyzed average weekday boardings at all bus and rail stops within the experimental and control corridors before and after the operation of the new light rail transit. As shown in Figure \@ref(fig:weekday-boarding-plot), the vertical dashed line indicates the date when the new light rail transit lines started operation. After the opening of the new light rail transit lines, boardings within the experimental corridor sharply increased while boardings within the control corridor decreased slightly for the Orange Line and almost kept stable for the Green Line. 

```{r}
###### Load and organize transit ridership and stop locations data 
# Extract weekday boardings within the experimental and control corridors 
# # Transit ridership data ====
# # Ridership dataset does not provide streetcar ridership 
# ridership <- read.csv("data/Passenger Census Dump - All.csv", as.is=TRUE)
# 
# month_df <- data.frame(month_num=c(1:12),
#                        month_char=c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"))
# 
# Weekday ridership 
# ridership_w <- ridership %>%
#                 filter(SERVICE_KEY=="W") %>%
#                 mutate(SUMMARY_BEGIN_DATE=as.character(SUMMARY_BEGIN_DATE),
#                        YEAR=as.numeric(substr(SUMMARY_BEGIN_DATE, 6,9)),
#                        month_char=substr(SUMMARY_BEGIN_DATE, 3,5),
#                        DAY=as.numeric(substr(SUMMARY_BEGIN_DATE, 1,2)),
#                        TIME=substr(SUMMARY_BEGIN_DATE, 11, 18),
#                        rt_dir_stopdesc=paste(ROUTE_NUMBER, DIRECTION, PUBLIC_LOCATION_DESCRIPTION, sep="_"),
#                        hm_char=substr(STOP_TIME, 1, 1),
#                        AM_PM=substr(STOP_TIME, nchar(STOP_TIME)-1, nchar(STOP_TIME)),
#                        AM_Peak=ifelse((hm_char %in% c(6, 7, 8, 9))&AM_PM=="AM", "AM Peak", "Non AM Peak"),
#                        PM_Peak=ifelse((hm_char %in% c(4, 5, 6, 7))&AM_PM=="PM", "PM Peak", "Non PM Peak"),
#                        AM_PM_Peak=ifelse(AM_Peak=="AM Peak"|PM_Peak=="PM Peak", "Peak Periods", "Non Peak Periods")
#                 )  %>%
#                 left_join(month_df) %>%
#                 mutate(date=ymd(paste(YEAR, month_num, DAY, sep="-")))
# 
# save(ridership_w, file = "output/intermediate/ridership_w.RData")

load("~/OrangeGreenLines/output/intermediate/ridership_w.RData")

# ridership_w <- ridership_w %>%
#               filter(date <= "2018-06-03")

###### Load Orange Line data 
# Use bus stops within corridor (first version of corridor: corridor areas are different in the first and second versions)
# # Load  experimental and control stops GIS bus stop data ====
# control_busstops <-  read.dbf("data/GIS/Control_Corridor_BusStops.dbf", as.is=TRUE)
# experimental_busstops <- read.dbf("data/GIS/Experimental_Corridor_BusStops.dbf", as.is=TRUE)
# 
# # RTE 200 is the MAX Green Line
# control_busstops <- control_busstops %>%
#                     mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))
# 
# # 194, 195, 196 are streetcar; no streetcar ridership in ridership dataset
# # RTE 290 is the MAX Orange Line
# experimental_busstops <- experimental_busstops %>%
#                          filter(!(RTE %in% c("194", "195", "196"))) %>%
#                          mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))
# 
# # extract ridership of control stops from ridership data
# ridership_w_control <- ridership_w %>%
#                           filter(rt_dir_stopdesc %in% control_busstops$rt_dir_stopdesc)
# 
# # all rt_dir_stopdesc are available from ridership dataset
# # sort(unique(ridership_w_rt_control$rt_dir_stopdesc))==sort(unique(control_busstops$rt_dir_stopdesc))
# 
# ridership_w_experimental <- ridership_w %>%
#                                filter(rt_dir_stopdesc %in% experimental_busstops$rt_dir_stopdesc)
# 
# # sort(unique(ridership_w_rt_experimental$rt_dir_stopdesc))==sort(unique(experimental_busstops$rt_dir_stopdesc))
# # There is one stops that do not appear in ridership dataset: SE McLoughlin & Park Ave is not in ridership dataset
# # setdiff(sort(unique(experimental_busstops$rt_dir_stopdesc)), sort(unique(ridership_w_rt_experimental$rt_dir_stopdesc)))

# Use bus stops within corridor1 (second version of corridor)
# Load GIS bus stop data of control corridor and experimental corridor 
ol_control_corridor1_busstops <-  read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Control_corridor1_busstops.dbf", as.is=TRUE) 
ol_experimental_corridor1_busstops <- read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Experimental_corridor1_busstops.dbf", as.is=TRUE) 

# RTE 200 is the MAX Green Line
ol_control_corridor1_busstops <- ol_control_corridor1_busstops %>%
                    mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

# 194, 195, 196 are streetcar; no streetcar ridership in ridership dataset
# RTE 290 is the MAX Orange Line
ol_experimental_corridor1_busstops <- ol_experimental_corridor1_busstops %>%
                          filter(!(RTE %in% c("194", "195", "196"))) %>%
                          mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

# extract ridership of control stops from ridership data 
ol_ridership_w_rt_control_corridor1 <- ridership_w %>%
                                      filter(rt_dir_stopdesc %in% ol_control_corridor1_busstops$rt_dir_stopdesc)

# all rt_dir_stopdesc are available from ridership dataset
# sort(unique(ridership_w_rt_control_corridor1$rt_dir_stopdesc))==sort(unique(control_corridor1_busstops$rt_dir_stopdesc))
 
ol_ridership_w_rt_experimental_corridorl <- ridership_w %>%
                                          filter(rt_dir_stopdesc %in% ol_experimental_corridor1_busstops$rt_dir_stopdesc)

# There are three stops do not show in riderhship dataset:  "291_0_SE McLoughlin & Park Ave", "33_1_SE Jefferson & Main", "34_1_SE Jefferson & Main" 
# setdiff(sort(unique(experimental_corridor1_busstops$rt_dir_stopdesc)), sort(unique(ridership_w_rt_experimental_corridorl$rt_dir_stopdesc)))

# Avoid recoding 
# Use data from Control_corridor1_busstops.dbf & Experimental_corridor1_busstops.dbf
ol_ridership_w_control <- ol_ridership_w_rt_control_corridor1
ol_ridership_w_experimental <- ol_ridership_w_rt_experimental_corridorl

###### Load Green Line data 
# Load GIS bus stop data of con and exp corridors 
gl_exp_busstops <- read.dbf("~/OrangeGreenLines/data/GIS/Green Line/Corridor2/GL_segment_main2clackamas_0.5m_buffer_busstops.dbf", as.is=TRUE) 
gl_con_busstops <- read.dbf("~/OrangeGreenLines/data/GIS/Green Line/Corridor2/I-5_segment_0.5m_buffer_busstops.dbf", as.is=TRUE) 

# 194, 195, 196 are streetcar; no streetcar ridership in ridership dataset
gl_exp_busstops <- gl_exp_busstops %>%
                            filter(!(RTE %in% c("194", "195", "196"))) %>%
                            mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

gl_con_busstops <- gl_con_busstops %>%
                       filter(!(RTE %in% c("194", "195", "196"))) %>%
                       mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))

gl_ridership_w_exp <- ridership_w %>%
                      filter(rt_dir_stopdesc %in% gl_exp_busstops$rt_dir_stopdesc)

gl_ridership_w_con <- ridership_w %>%
                      filter(rt_dir_stopdesc %in% gl_con_busstops$rt_dir_stopdesc)
```

```{r}
##### Orange Line analysis 
# Route 2  provides ridership from 2018-09-02 to present
# 291-Orange Night Bus provides ridership from 2015-09-13 to present 
# 290 MAX Orange Line provides ridership from 2015-09-13 to present 
ol_ridership_w_experimental_summary1 <- ol_ridership_w_experimental %>%
                                      filter(date >= "2012-09-02") %>% 
                                      group_by(ROUTE_NUMBER, date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

ol_ridership_w_experimental_summary2 <- ol_ridership_w_experimental %>%
                                      filter(!(ROUTE_NUMBER %in% c(2, 291)), date >= "2012-09-02") %>% 
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

# Route 2 only provide ridership from 2018-09-02 to present
# Route 73 only provide ridership from 2016-09-04 to present 
# Route 74 only provide ridership form 2018-03-04
# Ridership of RTE 200 MAX Green Line is from 2012-09-02 to present 
ol_ridership_w_control_summary1 <- ol_ridership_w_control %>%
  filter(date >= "2012-09-02") %>%
  group_by(ROUTE_NUMBER, date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

ol_ridership_w_control_summary2 <- ol_ridership_w_control %>%
  filter(!(ROUTE_NUMBER %in% c(2, 73, 74)), date >= "2012-09-02") %>%
  group_by(date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

# Orangeize ridership dataframe for DID regression 
ol_ridership_w_experimental_summary2 <- ol_ridership_w_experimental_summary2 %>%
  mutate(Group="Experimental corridor")

ol_ridership_w_control_summary2 <- ol_ridership_w_control_summary2 %>%
  mutate(Group="Control corridor")

ol_rs_did_df <- rbind(ol_ridership_w_experimental_summary2, ol_ridership_w_control_summary2) %>% 
             mutate(Before_after=ifelse(date >= "2015-09-13", 1, 0),
                    Year_1st=ifelse(date>="2015-09-13" & date <= "2016-06-05", 1, 0),
                    Year_2nd=ifelse(date>="2016-09-04" & date <= "2017-06-04", 1, 0),
                    Year_3rd=ifelse(date>="2017-09-03" & date <= "2018-06-03", 1, 0),
                    Year_4th=ifelse(date>="2018-09-02" & date <= "2019-03-03", 1, 0),
                    Line="Green Line")

###### Green Line analysis 
# Experimental ridership 
gl_ridership_w_exp_summary1 <- gl_ridership_w_exp %>%
                               group_by(ROUTE_NUMBER, PUBLIC_ROUTE_DESCRIPTION, date) %>%
                               summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                               ungroup()

# Select routes operate all the time 
# sort(table(gl_ridership_w_exp_summary1$ROUTE_NUMBER))
# Route 200 is the MAX Green Line
# Routes start service from 2007-03-04 to present 
gl_ridership_w_exp_rt <- gl_ridership_w_exp_summary1 %>%
                          group_by(ROUTE_NUMBER, PUBLIC_ROUTE_DESCRIPTION) %>%
                          summarise(date=min(date), 
                                    freq=n()) %>%
                          arrange(freq) %>%
                          filter(date=="2007-03-04"|ROUTE_NUMBER==200) %>% 
                          as.data.frame()

# Ridership within the experimental corridor by date 
gl_ridership_w_exp_summary2 <- gl_ridership_w_exp %>%
                               filter(ROUTE_NUMBER %in% gl_ridership_w_exp_rt$ROUTE_NUMBER) %>%
                               group_by(date) %>%
                               summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                               ungroup() %>%
                               mutate(Group="Experimental corridor")

# Control ridership 
gl_ridership_w_con_summary1 <- gl_ridership_w_con %>%
                                group_by(ROUTE_NUMBER, PUBLIC_ROUTE_DESCRIPTION, date) %>%
                                summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                ungroup()

# Select routes that operate all the time 
# sort(table(gl_ridership_w_con_summary1$ROUTE_NUMBER))
# Route 200 is the MAX Green Line
# Routes start service from 2007-03-04 to present 
gl_ridership_w_con_rt <- gl_ridership_w_con_summary1 %>%
                          group_by(ROUTE_NUMBER, PUBLIC_ROUTE_DESCRIPTION) %>%
                          summarise(date=min(date), 
                                    freq=n()) %>%
                          arrange(freq) %>%
                          filter(date=="2007-03-04") %>% #
                          as.data.frame()

gl_ridership_w_con_summary2 <- gl_ridership_w_con %>%
                               filter(ROUTE_NUMBER %in% gl_ridership_w_con_rt$ROUTE_NUMBER) %>%
                               group_by(date) %>%
                               summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                               ungroup() %>%
                               mutate(Group="Control corridor")

gl_bd_did_df <- rbind(gl_ridership_w_exp_summary2, gl_ridership_w_con_summary2) %>% 
                mutate(Before_after=ifelse(date >= "2009-09-13", 1, 0),
                       Year_1st=ifelse(date>="2009-09-13" & date <= "2010-06-06", 1, 0),
                       Year_2nd=ifelse(date>="2010-09-05" & date <= "2011-06-05", 1, 0),
                       Year_3rd=ifelse(date>="2011-09-04" & date <= "2012-06-03", 1, 0),
                       Year_4th=ifelse(date>="2012-09-02" & date <= "2013-06-02", 1, 0),
                       Year_5th=ifelse(date>="2013-09-01" & date <= "2014-06-01", 1, 0),
                       Year_6th=ifelse(date>="2014-08-31" & date <= "2015-06-07", 1, 0),
                       Year_7th=ifelse(date>="2015-09-13" & date <= "2016-06-05", 1, 0),
                       Year_8th=ifelse(date>="2016-09-04" & date <= "2017-06-04", 1, 0),
                       Year_9th=ifelse(date>="2017-09-03" & date <= "2018-06-03", 1, 0),
                       Year_10th=ifelse(date>="2018-09-02" & date <= "2019-03-03", 1, 0),
                       Line="Green Line"
                       )
```


```{r weekday-boarding-plot, fig.cap="Boardings at transit stops within \n the experimental/control corridors."}
# Reference: https://bookdown.org/yihui/rmarkdown-cookbook/cross-ref.html#cross-ref
ol_p_bd_ec_cc <- ggplot(ol_rs_did_df, aes(date, ONES_SUM), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
  geom_point(aes(colour=Group), size=0.75) +
 ggtitle("Orange Line") + # "Boardings at transit stops within \n the experimental/control corridors"
  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position=c(0.35, 0.15),
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=10)) + ylim(1000, 15000)

gl_p_bd_ec_cc <- ggplot(gl_bd_did_df, aes(date, ONES_SUM), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
                  geom_point(aes(colour=Group), size=0.75) +
                  ggtitle("Green Line") +
                  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2009-09-12"), linetype='dashed', size=0.3) +
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=10),
                        legend.position="none",
                        legend.title=element_text(family="Times",size=10, face="bold"),
                        legend.text=element_text(family="Times",size=10)) + ylim(1000, 15000)

grid.arrange(ol_p_bd_ec_cc, gl_p_bd_ec_cc, nrow = 1)
```

###### DID analysis 
```{r}
##### Orange Line 
# Base model 
ol_rs_did_base <- lm(ONES_SUM ~ Before_after*Group, data=ol_rs_did_df)

# Multiple time periods 
ol_rs_did_mt <- lm(ONES_SUM ~ Group*Year_1st + Group*Year_2nd + Group*Year_3rd + Year_4th*Group, data=ol_rs_did_df)

##### Green Line 
# Green Line boarding did base model 
gl_bd_did_base <- lm(ONES_SUM ~ Before_after*Group, data=gl_bd_did_df)

# Multiple time periods 
gl_bd_did_mt <- lm(ONES_SUM ~ Group*Year_1st + Year_2nd*Group + Year_3rd*Group +
                              Year_4th*Group + Year_5th*Group + Year_6th*Group +
                              Year_7th*Group + Year_8th*Group + Year_9th*Group +
                              Year_10th*Group, data=gl_bd_did_df)

stargazer(ol_rs_did_base, gl_bd_did_base, ol_rs_did_mt, gl_bd_did_mt, 
          column.labels = c("Orage Line", "Green Line", "Orage Line", "Green Line"),
          dep.var.labels=c("Boardings"),
          type="text", title="Ridership DID base and multiple time priods models", keep.stat=c("n", "rsq", "adj.rsq", "ser"))

```

Difference-in-Differences effects shown in Figure \@ref(fig:difference-in-differences-effects-boardings) 

```{r difference-in-differences-effects-boardings, fig.cap="Difference-in-Differences effects of boardings"}
# Plots of base models 
# Base model matrix 
bm_mx <- matrix(c(1, 1, 1, 1, 1, 1,
                  0, 1, 0, 1, 0, 1,
                  0, 0, 1, 1, 1, 1, 
                  0, 0, 0, 1, 0, 0), nrow=4, byrow=TRUE)

##### Orange Line 
# major arterial speed base models
ol_rs_did_base_coef_mx <- t(as.matrix(summary(ol_rs_did_base)$coefficient[, 1]))


ol_rs_did_base_df <- data.frame(Group=rep(c("Control", "Treated", "Counterfactual"), each=2), 
                             Before_after=rep(c("before", "after"), 3),
                             boardings=as.numeric(ol_rs_did_base_coef_mx %*% bm_mx)) %>%
                  mutate(Before_after=ifelse(Before_after=="after", 1, 0)) 

ol_p_rs_did_base <-  ggplot(ol_rs_did_base_df, aes(x=Before_after, y=boardings, group=Group)) +
                    geom_line(aes(color=Group)) + geom_point() + ylab("Boardings") + 
                    xlab("Time (after=1)")  + scale_x_continuous(breaks=c(0, 1)) + 
                    ggtitle("Orange Line") + 
                    theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                          axis.text = element_text(family="Times",size=8),
                          axis.title=element_text(family="Times",size=12),
                          legend.position="none",
                          legend.title=element_text(family="Times",size=12, face="bold"),
                          legend.text=element_text(family="Times",size=8)) 


##### Green Line
# major arterial speed base models
gl_bd_did_base_coef_mx <- t(as.matrix(summary(gl_bd_did_base)$coefficient[, 1]))

gl_bd_did_base_df <- data.frame(Group=rep(c("Control", "Treated", "Counterfactual"), each=2), 
                             Before_after=rep(c("before", "after"), 3),
                             boardings=as.numeric(gl_bd_did_base_coef_mx %*% bm_mx)) %>%
                     mutate(Before_after=ifelse(Before_after=="after", 1, 0)) 

gl_p_bd_did_base <-  ggplot(gl_bd_did_base_df, aes(x=Before_after, y=boardings, group=Group)) +
                        geom_line(aes(color=Group)) + geom_point() + ylab("Boardings") + 
                        xlab("Time (after=1)")  + scale_x_continuous(breaks=c(0, 1)) + 
                        ggtitle("Green Line") + 
                        theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                              axis.text = element_text(family="Times",size=8),
                              axis.title=element_text(family="Times",size=12),
                              legend.position=c(0.25, 0.75),
                              legend.title=element_text(family="Times",size=12, face="bold"),
                              legend.text=element_text(family="Times",size=8)) 

grid.arrange(ol_p_rs_did_base, gl_p_bd_did_base, nrow = 1)
```

Figure \@ref(fig:predicted-average-boardings)

```{r predicted-average-boardings, fig.cap="Predicted average boardings within the experimental/control corridors."}
# Plots of models with multiple time periods 
##### Orange Line
mt_4yd_mx <- matrix(c(rep(1, 5),
                      rep(1, 5),
                      0, 1, 0, 0, 0,
                      0, 0, 1, 0, 0,
                      0, 0, 0, 1, 0,
                      0, 0, 0, 0, 1,
                      0, 1, 0, 0, 0,
                      0, 0, 1, 0, 0,
                      0, 0, 0, 1, 0,
                      0, 0, 0, 0, 1), 
                      nrow=10, byrow=TRUE)

# AM outbound 
ol_rs_did_mt_coef_mx <- t(as.matrix(summary(ol_rs_did_mt)$coefficient[, 1]))
ol_rs_did_mt_coef_sesq_mx <- t(as.matrix(summary(ol_rs_did_mt)$coefficient[, 2]))^2

ol_rs_did_mt_df <- data.frame(TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year"), ordered = TRUE, 
                                            levels=c("Before", "1st year", "2nd year", "3rd year", "4th year")),
                           Boardings=as.numeric(ol_rs_did_mt_coef_mx %*% mt_4yd_mx),
                           Boardings_se=as.numeric(sqrt(ol_rs_did_mt_coef_sesq_mx %*% mt_4yd_mx)))

# Average treated effect: 11744=sum(summary(rs_did_base)$coefficient[,1])
ol_p_rs_did_mt <-  ggplot(ol_rs_did_mt_df, aes(x=TreatTime, y=Boardings, group=1)) +
  geom_line() + geom_point() + 
  geom_errorbar(aes(ymin=Boardings-1.96*Boardings_se, ymax=Boardings+1.96*Boardings_se, width=.1)) + # , position=position_dodge(0.05)
  geom_hline(yintercept = c(11744), color=c('#999999'), linetype="dashed")+
  xlab("Treatment time periods") + ylab("Boardings") + # ylim(25, 30) +
  ggtitle("Orange Line") + scale_color_manual(values=c('#999999')) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=12),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=12, face="bold"),
        legend.text=element_text(family="Times",size=8)) 


##### Green Line
# Plot for DID with multiple time periods 
# plot DID models with three year dummy variables 
mt_10yd_mx <- matrix(c(rep(1, 11),
                      rep(1, 11),
                      0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                      
                      0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
                      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),
                      nrow=22, byrow=TRUE)

gl_bd_did_mt_coef_mx <- t(as.matrix(summary(gl_bd_did_mt)$coefficient[, 1]))
gl_bd_did_mt_coef_sesq_mx <- t(as.matrix(summary(gl_bd_did_mt)$coefficient[, 2]))^2

gl_bd_did_mt_df <- data.frame(TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year", "6th year",
                                              "7th year", "8th year", "9th year", "10th year"), ordered = TRUE, 
                                            levels=c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year", "6th year",
                                                     "7th year", "8th year", "9th year", "10th year")),
                           Boardings=as.numeric(gl_bd_did_mt_coef_mx %*% mt_10yd_mx),
                           Boardings_se=as.numeric(sqrt(gl_bd_did_mt_coef_sesq_mx %*% mt_10yd_mx))
                           )

# Average treated effect: 10018=sum(summary(gl_bd_did_base)$coefficient[,1])
gl_p_bd_did_mt <-  ggplot(gl_bd_did_mt_df, aes(x=TreatTime, y=Boardings, group=1)) +
        geom_line() + geom_point() + 
        geom_errorbar(aes(ymin=Boardings-1.96*Boardings_se, ymax=Boardings+1.96*Boardings_se, width=.1)) + # , position=position_dodge(0.05)
        geom_hline(yintercept = c(10018), color=c('#999999'), linetype="dashed")+
        xlab("Treatment time periods") + ylab("Boardings") + # ylim(25, 30) +
        ggtitle("Green Line") + scale_color_manual(values=c('#999999')) +
        theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
              axis.text = element_text(family="Times",size=8),
              axis.title=element_text(family="Times",size=12),
              legend.position="bottom",
              legend.title=element_text(family="Times",size=12, face="bold"),
              legend.text=element_text(family="Times",size=8)) 


grid.arrange(ol_p_rs_did_mt, gl_p_bd_did_mt, nrow = 1)
```



Then, I divide the ridership within the experimental corridor into new light rail transit and existing transit. Shown in Figure \@ref(fig:boardings-NewTransitLine-ExistingTransit).The average weekday ridership of Orange line and Green Line exceeded 5000 and 6000 respectively, while the ridership of the existing transit was relative stable after the operation of the new light rail transit lines. Most of the increase in ridership is from the new light rail transit, indicating that the new light rail transit has contributed to the increased transit ridership. 
```{r boardings-NewTransitLine-ExistingTransit, fig.cap="Boardings at MAX Orange Line and exisitng transit stops within experimental corridor"}
##### Orage Line 
# ridership of Orange Line and Existing transit data.frame 
# Route 2  provides ridership from 2018-09-02 to present
# 291-Orange Night Bus provides ridership from 2015-09-13 to present 
# 290 MAX Orange Line provides ridership from 2015-09-13 to present 
ol_ridership_w_experimental_summary3 <- ol_ridership_w_experimental %>%
                                      filter(ROUTE_NUMBER %in% c(290)) %>% # Route 290 MAX Orange Line  
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup() 

ol_ridership_w_experimental_summary3 <- ol_ridership_w_experimental_summary3 %>%
                                        mutate(Group="MAX Orange Line")

# Existing bus ridership within experimental corridor 
ol_ridership_w_experimental_summary4 <- ol_ridership_w_experimental %>%
                                      filter(!(ROUTE_NUMBER %in% c(2, 290, 291)), date >= "2012-09-02") %>% 
                                      group_by(date) %>%
                                      summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                                      ungroup()

ol_ridership_w_experimental_summary4 <- ol_ridership_w_experimental_summary4 %>%
                                     mutate(Group="Existing Transit")

ol_rs_ol_et <- rbind(ol_ridership_w_experimental_summary3, ol_ridership_w_experimental_summary4)

# plot of ridership of MAX Orange Line and Exisitng transit data.frame 
ol_p_rs_ol_et <- ggplot(ol_rs_ol_et, aes(date, ONES_SUM, color=Group), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
  geom_point(size=0.75) + scale_color_manual(values=c("#A569BD", "#F8C471")) + 
  ggtitle("Orange Line") +
  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + ylim(1000, 7000) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=10))  

# ol_p_rs_ol_et

##### Green Line
# MAX Green Line ridership by date 
gl_ridership_w_exp_summary3 <- gl_ridership_w_exp %>%
                               filter(ROUTE_NUMBER == 200) %>%
                               group_by(date) %>%
                               summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                               ungroup() %>%
                               mutate(Group="MAX Green Line")

# Existing transit service ridership within the experimental corridor 
gl_ridership_w_exp_summary4 <- gl_ridership_w_exp %>%
                               filter(ROUTE_NUMBER %in% gl_ridership_w_exp_rt$ROUTE_NUMBER, ROUTE_NUMBER != 200) %>%
                               group_by(date) %>%
                               summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
                               ungroup()  %>%
                               mutate(Group="Existing Transit")

gl_bd_gl_et <- rbind(gl_ridership_w_exp_summary3, gl_ridership_w_exp_summary4)

# plot of ridership of MAX Orange Line and Exisitng transit data.frame 
gl_p_bd_gl_et <- ggplot(gl_bd_gl_et, aes(date, ONES_SUM, color=Group), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
        geom_point(size=0.75) + scale_color_manual(values=c("#A569BD", "#F8C471")) + 
        ggtitle("Green Line") +
        labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2009-09-12"), linetype='dashed', size=0.3) + ylim(1000, 7000) +
        theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
              axis.text = element_text(family="Times",size=8),
              axis.title=element_text(family="Times",size=9),
              legend.position="bottom",
              legend.title=element_text(family="Times",size=9, face="bold"),
              legend.text=element_text(family="Times",size=10))  

# gl_p_bd_gl_et

grid.arrange(ol_p_rs_ol_et, gl_p_bd_gl_et, nrow = 1)
```

##### Traverse bus lines 
Then, this study compares ridership of bus lines that run through the the experimental and control corridors. In the experimental corridor, these lines connect the southeast Portland with downtown Portland and therefore provide alternative option to the Orange Line. Shown in the Figure \@ref(fig:OL-travers-bl-bd), these lines cross the screenlines. Results show that total bidirectional ridership at all stations of these lines within experimental corridor decreased at a larger rate compared to corresponding bus lines within the control corridor after the operation of the Orange Line. The results seems to indicate that a small portion of increase in transit ridership switch form the existing bus service. 

```{r OL-travers-bl-bd, fig.cap="Boardings of traverse bus lines within the experimental/control corridors"}
##### Orange Line 
# Routes 19, 30, 70, 291 cross the screenline 
# Orange Line traverse bus lines ridership within the experimental corridor 
ol_tbl_bd_experimental2  <- ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(19, 30, 70, 291), date >= "2012-09-02")  %>% 
  group_by(date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup()  %>%
  mutate(Group="Experimental corridor")

# ggplot(ridership_experimental2, aes(date, ONES_SUM)) + geom_point() + geom_smooth()  +
#  ggtitle("average total weekday ridership of east–west \n transit lines within the experimental corridor (exclude Orange Line")

# Control corridor  
# East-west routes: 9, 10, 14, 17, 
# North-south: 71, 72, 75, 
# Route 66 west part/short 
# 200 MAX Green Line 

# East-west route 9, 17 cross the screenliens 
ol_tbl_bd_control  <- ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(9, 17), date >= "2012-09-02")  %>% 
  group_by(date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(Group="Control corridor")

# ggplot(ridership_control, aes(date, ONES_SUM)) + geom_point() + geom_smooth() + ylim (11000, 20000) +
#  ggtitle("average total weekday ridership of east–west \n transit lines within the control corridor")

ol_tbl_bd_exp_con <- rbind(ol_tbl_bd_experimental2, ol_tbl_bd_control)

ol_p_tbl_bd <- ggplot(ol_tbl_bd_exp_con, aes(date, ONES_SUM), group=Group) + geom_smooth(aes(linetype=Group), color="#909497") +
                  geom_point(aes(colour=Group), size=0.75) + 
                  ggtitle("Orange Line") +
                  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=10),
                        legend.position="bottom",
                        legend.title=element_text(family="Times",size=10, face="bold"),
                        legend.text=element_text(family="Times",size=10)) # + ylim(3000, 17000)


```

##### Ridership of traverse bus lines during peak periods 
Only drivers switching from driving to transit during peak periods can relieve traffic congestion, I analyzed the weekday peak-period bidirectional ridership of the Orange Line and existing bus lines that traverse the same screenline. Shown in the Figure \@ref(fig:OL-travers-bl-bd-pp), ridership of the existing parallel bus lines decreased slightly while the ridership of the Orange Line is much larger than the decreased ridership of the existing parallel bus lines. The combined effect shows that there is an overall increase in transit ridership within the experimental corridor. 

```{r OL-travers-bl-bd-pp, fig.cap="Peak periods bidirectional boardings of MAX \n Orange Line and traverse bus lines"}
ridership_rt_experimental_peak2  <-  ridership_w %>% 
  filter(ROUTE_NUMBER %in% c(19, 30, 70, 290, 291), date >= "2012-09-02", AM_PM_Peak=="Peak Periods")  %>% 
  mutate(Transit=ifelse(ROUTE_NUMBER==290, "MAX Orange Line", "Existing parallel bus lines"))  %>% 
  group_by(Transit, date)  %>% 
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE)) %>%
  ungroup() 

 ggplot(ridership_rt_experimental_peak2, aes(date, ONES_SUM, color=Transit), group=Transit) +       geom_smooth(aes(linetype=Transit), color="#909497") +
                  geom_point(size=0.75) + scale_color_manual(values=c("#A569BD", "#F8C471")) + 
                  ggtitle("Orange Line") +
                  labs(x="Date", y="Boardings") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + 
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=9),
                        legend.position="bottom",
                        legend.title=element_text(family="Times",size=9, face="bold"),
                        legend.text=element_text(family="Times",size=10))  #+ ylim(4000, 14000) 
```

##### Boardings and alightings at specific bus stops within a quarter-mile network distance of MAX Orange Line stations.
Lastly, I compared boardings and alightings at bus stops that are within a quarter-mile network distance of Orange Line stops before and after the operation of the Orange Line. Shown in the Figure \@ref(fig:p-bd-alght), boardings and alightings both largely increased after the operation of the new light rail transit lines. Due to the limitation of data, it is hard to figure out whether such increases result from new ridership or a switch from the existing riderhship. 

```{r p-bd-alght, fig.cap="Boardings at specific bus stops within a quarter-mile walking radius of new light rail transit stations"}
###### Orange Line 
ol_bus_stops_quarter_mile <- read.dbf("~/OrangeGreenLines/data/GIS/Orange Line/Bus_stops_quarter_mile_withoutMAX_SC.dbf", as.is=TRUE) 

ol_bus_stops_quarter_mile <- ol_bus_stops_quarter_mile %>%
                              mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))  %>%
                              select(RTE, DIR, LOCATION,  rt_dir_stopdesc) # , join_STATI

ol_ridership_bus_stops_quarter_mile <- ridership_w %>%
  filter(rt_dir_stopdesc %in% ol_bus_stops_quarter_mile$rt_dir_stopdesc) %>%
  left_join(ol_bus_stops_quarter_mile)  


ol_ridership_bus_stops_quarter_mile_summary1 <- ol_ridership_bus_stops_quarter_mile %>%
  filter(!(ROUTE_NUMBER %in% c(2)), date >= "2012-09-02") %>% # Route 2 provides ridership from 2018-09-02 to present
  group_by(date) %>%
  summarise(ONES_SUM=sum(ONS, na.rm = TRUE),
            OFFS_SUM=sum(OFFS, na.rm = TRUE))

ol_ridership_bus_stops_quarter_mile_summary1_long <- gather(ol_ridership_bus_stops_quarter_mile_summary1, Ridership, Amount, ONES_SUM:OFFS_SUM, factor_key=TRUE) %>%
                                                  mutate(Ridership=ifelse(Ridership=="ONES_SUM", "Boardings", "Alightings"))

ol_p_bd_alght <- ggplot(ol_ridership_bus_stops_quarter_mile_summary1_long, aes(date, Amount, color=Ridership), group=Ridership) + geom_smooth() + 
  geom_point(size=0.75) +ggtitle("Orange Line") +
  labs(x="Date", y="Amount") + geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) + ylim(0, 3000) + 
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position="none",
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=8)) 

###### Green Line
# Green Line boarding and alighting analysis 
gl_bus_stops_quarter_mile <-  read.dbf("~/OrangeGreenLines/data/GIS/Green Line/Corridor2/GL_service_area_402meters_bus_stops_withoutMAXStations.dbf", as.is=TRUE) 


gl_bus_stops_quarter_mile <- gl_bus_stops_quarter_mile %>%
                              mutate(rt_dir_stopdesc=paste(RTE, DIR, LOCATION, sep="_"))  %>%
                              select(RTE, DIR, LOCATION,  rt_dir_stopdesc) # , join_STATI

gl_ridership_bus_stops_quarter_mile <- ridership_w %>%
                                        filter(rt_dir_stopdesc %in% gl_bus_stops_quarter_mile$rt_dir_stopdesc) %>%
                                        left_join(gl_bus_stops_quarter_mile)  

gl_ridership_bus_stops_quarter_mile_summary1 <- gl_ridership_bus_stops_quarter_mile %>%
                                                filter(ROUTE_NUMBER %in% gl_ridership_w_exp_rt$ROUTE_NUMBER) %>% # Select Routes that start service from 2007-03-04 to present
                                                group_by(date) %>%
                                                summarise(ONES_SUM=sum(ONS, na.rm = TRUE),
                                                          OFFS_SUM=sum(OFFS, na.rm = TRUE))

gl_ridership_bus_stops_quarter_mile_summary1_long <- gather(gl_ridership_bus_stops_quarter_mile_summary1, Ridership, Amount, ONES_SUM:OFFS_SUM, factor_key=TRUE) %>%
  mutate(Ridership=ifelse(Ridership=="ONES_SUM", "Boardings", "Alightings"))

gl_p_bd_alght <- ggplot(gl_ridership_bus_stops_quarter_mile_summary1_long, aes(date, Amount, color=Ridership), group=Ridership) + geom_smooth() + 
  geom_point(size=0.75) +ggtitle("Green Line") +
  labs(x="Date", y="Amount") + geom_vline(xintercept=ymd("2009-09-12"), linetype='dashed', size=0.3) + ylim(0, 3000) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=10, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=10),
        legend.position=c(0.8, 0.1),
        legend.title=element_text(family="Times",size=10, face="bold"),
        legend.text=element_text(family="Times",size=8)) 

grid.arrange(ol_p_bd_alght, gl_p_bd_alght, nrow = 1)
```


In summary, the results of these analyses show that there has been a net increase in transit ridership in the experimental corridor after the opening of the Orange Line. ?write more? 


## Traffic congestion 
This study focuses on the impacts on traffic congestion and thus I only examine the changes in travel speed during weekday AM and PM peak periods. The peak periods are consistent with Portland metropolitan area Travel Demand Modeling. The AM peak is 7 to 10 AM, and the PM peak is 4 to 7 PM. 

### Plot
An important goal of the MAX Orange Line is to relieve traffic congestion on the parallel roadways, and therefore I investigate the impacts on traffic congestion on the SE McLoughlin Blvd. The SE McLoughlin Blvd is almost parallel to the MAX Orange Line and carries very large daily traffic volumes. The impacts are expected to concentrate within the experimental segment of SE McLoughlin Blvd. Shown in Figure ***, the experimental segment is the part within the experimental corridor and the control segment is the part within the control corridor. 

To examine the impact of the Orange Line on traffic congestion, this study examines travel speed and its reliability. First, I Investigate the changes in average speed on experimental and control roadways by peak period (AM and PM peak) and directions (inbound to/outbound from CBD), shown in Figure \@ref(fig:ol-wdpeak-speed). Before the operation of the MAX Orange Line, the trend of average peak period travel speed on experimental and control roadway segments are the same, which meets the assumption of DID approach. After the operation of the MAX Orange Line, both inbound to CBD and outbound from CBD travel speed on control roadway segment for AM and PM peak periods kept almost constant, while both inbound to and outbound from CBD average peak periods travel speed on the experimental segment overall increased. The growth rate of outbound from CBD speed for AM peak period is largest and followed by inbound to CBD speed for PM peak.

```{r ol-wdpeak-speed, fig.cap="Orange Line Weekday peak periods speed"}
##### Orange Line 
# source("code/OL_prepare_data.R")
 load("~/OrangeGreenLines/output/intermediate/data_combined_day_wdpeak.RData")

 data_combined_day_wdpeak <- data_combined_day_wdpeak %>%
                             filter(DDV_his_em_avg > 0)  

 data_combined_day_wdpeak_ma <- data_combined_day_wdpeak %>%
                               select(roadway, date, AM_PM, before_after, Speed=AvgSpeed) %>%
                               filter(roadway %in% c("McLoughlin_S", "Powell_E", "McLoughlin_N", "Powell_W")) %>%
                               mutate(Direction=ifelse(roadway %in% c("McLoughlin_S", "Powell_E"), "Outbound from CBD", "Inbound to CBD"),
                                      Group=ifelse(roadway %in% c("Powell_W", "Powell_E"), "Control (Powell Blvd)", 
                                                                  "Experimental (McLoughlin Blvd)"))

 ol_p_sp_ma_4g <- ggplot(data=data_combined_day_wdpeak_ma, aes(x=date, y=Speed, group=Group, colour=Group)) +
                  geom_point() + geom_smooth(aes(linetype=Group), colour="yellow", size=0.75) + 
                  geom_vline(xintercept=ymd("2015-09-12"), linetype='dashed', size=0.3) +  ylim(0, 50) + ggtitle("Orange Line Weekday peak periods speed")+
                  labs(x="Date", y="Speed (mph)") + facet_grid(AM_PM ~ Direction) +
                  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                        axis.text = element_text(family="Times",size=8),
                        axis.title=element_text(family="Times",size=12),
                        legend.position="bottom",
                        legend.title=element_text(family="Times",size=12, face="bold"),
                        legend.text=element_text(family="Times",size=10),
                        strip.text = element_text(size = 10)
                  ) 
  
 ol_p_sp_ma_4g
 
```

Figure \@ref(fig:gl-wdpeak-speed)
```{r gl-wdpeak-speed, fig.cap="Green Line Weekday peak periods speed"}
##### Green Line 
load("~/OrangeGreenLines/output/intermediate/GL_DID_0414_I5_I205_I84_bd_df.RData")

roadway_label_df <- data.frame(roadway=c("I-205 North", "I-205 South", "I-5 North", "I-5 South", "I-84 East", "I-84 West"), 
                               ec_Group=c("Experimental (I-205)", "Experimental (I-205)", "Control (I-5)", 
                                          "Control (I-5)", "Experimental (I-84)", "Experimental (I-84)")) %>%
  mutate(roadway=as.character(roadway),
         ec_Group=as.character(ec_Group))

GL_DID_0814_I5_I205_I84_bd_df <- GL_DID_0414_I5_I205_I84_bd_df %>%
  filter(date>="2008-09-12") %>%
  mutate(Direction=ifelse(roadway %in% c("I-5 North", "I-205 North", "I-84 West"), "Inbound to CBD", "Outbound from CBD")) %>%
  left_join(roadway_label_df)

gl_p_sp_I5_I205_4g <- ggplot(data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway %in% c("I-205 North", "I-205 South", "I-5 North", "I-5 South")), 
       aes(x=date, y=r_speed, group=ec_Group, colour=ec_Group)) +
  geom_point() + geom_smooth(aes(linetype=ec_Group), colour="yellow", size=0.75) + 
  geom_vline(xintercept=ymd("2009-09-12"), linetype='dashed', size=0.3)  + ggtitle("Green Line Weekday peak periods speed") +  ylim(0, 100) + 
  labs(x="Date", y="Speed (mph)") + facet_grid(AM_PM ~ Direction) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=12),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=12, face="bold"),
        legend.text=element_text(family="Times",size=10),
        strip.text = element_text(size = 10)) 

gl_p_sp_I5_I205_4g
```

### T-test
Table *** shows the descriptive analysis of speed on control and experimental roadway segments by peak periods and directions. Comparisons are conducted between before and after periods for each case. Of the four experimental comparison cases, average speed increased in three cases, all of which are statistically significant; in the remaining case (PM peak outbound from CBD), average speed decreased by 0.7 mph, which is smaller than the decrease rate (-2.2 mph) of corresponding control case. The results of the descriptive analysis indicate that the MAX Orange Line has had a relief impact on the experimental roadway segment.


```{r}
# Orange Line 
# # Calculate average speed and standard deviation
# data_combined_day_wdpeak_ma %>%
#               group_by(roadway, AM_PM, before_after) %>%
#               summarise(Speed_avg=mean(Speed, na.rm=TRUE),
#                          Speed_sd=sd(Speed, na.rm=TRUE))
# 
# # T-test
# # Major Arterials
# # AM Peak period
# # AM inward CBD: experiment
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: experiment
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM inward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="AM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="AM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM Peak period
# # PM inward CBD: experiment
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_N", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: experiment
# t.test(data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="McLoughlin_S", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM inward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_W", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: control
# t.test(data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="PM", before_after==0) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector(),
#        data_combined_day_wdpeak %>% filter(roadway=="Powell_E", AM_PM=="PM", before_after==1) %>% select(AvgSpeed) %>% as.data.frame() %>% as.vector())

# Insert before after t-test table 
knitr::include_graphics("Table picture.png")
```

```{r}
###### Green Line 
# # T-test====
# # Major Arterials
# # AM Peak period
# # AM inward CBD: experiment
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 North", AM_PM=="AM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 North", AM_PM=="AM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: experiment
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 South", AM_PM=="AM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 South", AM_PM=="AM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # AM inward CBD: control
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 North", AM_PM=="AM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 North", AM_PM=="AM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # AM outward CBD: control
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 South", AM_PM=="AM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 South", AM_PM=="AM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # PM Peak period
# # PM inward CBD: experiment
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 North", AM_PM=="PM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 North", AM_PM=="PM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: experiment
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 South", AM_PM=="PM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-205 South", AM_PM=="PM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # PM inward CBD: control
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 North", AM_PM=="PM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 North", AM_PM=="PM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())
# 
# # PM outward CBD: control
# t.test(GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 South", AM_PM=="PM", Before_after==0) %>% select(r_speed) %>% as.data.frame() %>% as.vector(),
#        GL_DID_0814_I5_I205_I84_bd_df %>% filter(roadway=="I-5 South", AM_PM=="PM", Before_after==1) %>% select(r_speed) %>% as.data.frame() %>% as.vector())

# Insert before after t-test table 
knitr::include_graphics("gl_I205_ttest_table.png")
```


### DID base regression 
A one-group pre-treatment/post-treatment comparison of the experimental roadway segment is weak because it lacks a control group and it may be in doubt to attribute the changes to the operation of the Orange Line. To circumvent this weakness, this study, therefore, utilized a difference-in-difference (DID) approach. The following table shows the results of the DID regression model. Of the four models, compared to the control roadway segment and pre-operation period, the coefficients of DID estimators indicate a significant relative increase in the speed of the experimental roadway in all cases, indicating that the Orange Line has a relief effect on traffic congestion on the experimental segment. The size of impacts is different across the AM/PM peak periods and inbound to/outbound from CBD directions. 

```{r}
##### Orange Line 
# Base models
sp_amo_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group,
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="AM"))

sp_ami_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="AM"))

sp_pmo_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                    data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="PM"))

sp_pmi_day_ma <- lm(AvgSpeed ~ before_after + ec_group + before_after*ec_group, 
                      data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="PM"))

stargazer(sp_amo_day_ma, sp_ami_day_ma, sp_pmo_day_ma, sp_pmi_day_ma, 
              column.labels = c("AM Outbound", "AM Inbound", "PM Outbound",  "PM Inbound"),
              dep.var.labels=c("Travel Speed"),
              covariate.labels=c("Time Period (after = 1)", "Group (experimental group = 1)", "Time Period × Group"),
              type="text", title="Orange Line speed base models", keep.stat=c("n", "rsq", "adj.rsq", "ser")) 

```


```{r}
##### Green Line 
# Base DID regression  models 
# Inbound 
GL_DID_0814_AM_inbound_I5_I205 <- lm(r_speed ~ Before_after + Group + Group*Before_after, 
                                     data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="AM", roadway %in% c("I-5 North", "I-205 North")))
GL_DID_0814_PM_inbound_I5_I205 <- lm(r_speed ~ Before_after + Group + Group*Before_after, 
                                     data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="PM", roadway %in% c("I-5 North", "I-205 North")))

# Outbound
GL_DID_0814_AM_outbound_I5_I205 <- lm(r_speed ~ Before_after + Group + Group*Before_after, 
                                      data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="AM", roadway %in% c("I-5 South", "I-205 South")))
GL_DID_0814_PM_outbound_I5_I205 <- lm(r_speed ~ Before_after + Group + Group*Before_after,
                                      data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="PM", roadway %in% c("I-5 South", "I-205 South")))

# Using I-205 as the experimental corridor 
stargazer(GL_DID_0814_AM_inbound_I5_I205, GL_DID_0814_PM_inbound_I5_I205,  GL_DID_0814_AM_outbound_I5_I205, GL_DID_0814_PM_outbound_I5_I205,
          column.labels = c("AM Inbound", "PM Inbound", "AM Outbound", "PM Outbound"),
          dep.var.labels=c("Travel Speed"),
          covariate.labels=c("Time Period (after = 1)", "Group (experimental group = 1)", "Time Period × Group"),
          type="text", title="GL Route Travel Speed 09/12/2004-09/12/2014 & I-84 as the experimental corridor", keep.stat=c("n", "rsq", "adj.rsq", "ser"))  
```


Using the results of the DID models, the following figure displays the changes in average peak period travel speed from before to after (Time = 1) the operation of the Orange Line for both the experimental and control roadway segments by directions and peak periods. The "counterfactual" line shows what might have happened in the absence of the operation of the Orange Line, assuming the change in travel speed on the experimental roadway segment would be the same as the change in travel speed on the control roadway segment. As shown in Figure \@ref(fig:ol-sp-did-base), travel speed on the experimental roadway segment for after period is higher than that in the counterfactual scenario for after period. This reveals that the operation of the Orange Line has had a relief effect on travel speed on the experimental roadway segment.


```{r ol-sp-did-base, fig.cap="Orange Line DID base models for weekday peak periods speed"}
##### Orange Line 
# Plots 
# Plot base DID models ====
# Specify base model matrix 
bm_mx <- matrix(c(1, 1, 1, 1, 1, 1,
                  0, 1, 0, 1, 0, 1,
                  0, 0, 1, 1, 1, 1, 
                  0, 0, 0, 1, 0, 0), nrow=4, byrow=TRUE)

# major arterial speed base models
sp_amo_day_ma_coef_mx <- t(as.matrix(summary(sp_amo_day_ma)$coefficient[, 1]))
sp_ami_day_ma_coef_mx <- t(as.matrix(summary(sp_ami_day_ma)$coefficient[, 1]))
sp_pmo_day_ma_coef_mx <- t(as.matrix(summary(sp_pmo_day_ma)$coefficient[, 1]))
sp_pmi_day_ma_coef_mx <- t(as.matrix(summary(sp_pmi_day_ma)$coefficient[, 1]))

sp_did_ma_df <- data.frame(Group=rep(c("Control", "Treated", "Counterfactual"), each=2), 
                           Before_after=rep(c("before", "after"), 3),
                           sp_amo_day_ma_speed=as.numeric(sp_amo_day_ma_coef_mx %*% bm_mx),
                           sp_ami_day_ma_speed=as.numeric(sp_ami_day_ma_coef_mx %*% bm_mx),
                           sp_pmo_day_ma_speed=as.numeric(sp_pmo_day_ma_coef_mx %*% bm_mx),
                           sp_pmi_day_ma_speed=as.numeric(sp_pmi_day_ma_coef_mx %*% bm_mx)) 


sp_did_ma_df$Before_after <- relevel(sp_did_ma_df$Before_after, "before")

sp_amo_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_amo_day_ma_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Outbound from CBD")

sp_ami_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_ami_day_ma_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Inbound to CBD")

sp_pmo_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_pmo_day_ma_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Outbound from CBD")

sp_pmi_day_ma_speed_df <- sp_did_ma_df %>%
  select(Group, Before_after, Speed=sp_pmi_day_ma_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Inbound to CBD")

sp_did_ma_df_long <- rbind(sp_amo_day_ma_speed_df, sp_ami_day_ma_speed_df, sp_pmo_day_ma_speed_df, sp_pmi_day_ma_speed_df) %>%
                     mutate(Scenario=paste(AM_PM, Direction, sep=" "),
                            Before_after=ifelse(Before_after=="after", 1, 0))

# Plot of two peak periods and two directions 
p_sp_did_ma_4g <-  ggplot(sp_did_ma_df_long, aes(x=Before_after, y=Speed, group=Group)) +
                    geom_line(aes(color=Group)) + geom_point() + ylab("Speed (MPH)") + 
                    xlab("Time (after=1)")  + scale_x_continuous(breaks=c(0, 1)) + 
                    ggtitle("Orange Line DID models for weekday peak periods speed") +  facet_grid(AM_PM ~ Direction) + 
                    theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
                          axis.text = element_text(family="Times",size=8),
                          axis.title=element_text(family="Times",size=9),
                          legend.position="bottom",
                          legend.title=element_text(family="Times",size=9, face="bold"),
                          legend.text=element_text(family="Times",size=8)
                    ) 

p_sp_did_ma_4g

ggsave(file="output/plots/OL DID plots/p_sp_did_ma_4g.png", p_sp_did_ma_4g, width=5, heigh=4)
```

Figure \@ref(fig:gl-sp-did-base)

```{r gl-sp-did-base, fig.cap="Green Line DID base models for weekday peak periods speed"}
##### Green Line 
# Plot the DID results with I-84 as the experimental corridor ====
# Plot 
# Specify base model matrix 
bm_mx <- matrix(c(1, 1, 1, 1, 1, 1,
                  0, 1, 0, 1, 0, 1,
                  0, 0, 1, 1, 1, 1, 
                  0, 0, 0, 1, 0, 0), nrow=4, byrow=TRUE)

# GL speed base models
sp_ami_day_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_AM_inbound_I5_I205)$coefficient[, 1]))
sp_pmi_day_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_PM_inbound_I5_I205)$coefficient[, 1]))
sp_amo_day_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_AM_outbound_I5_I205)$coefficient[, 1]))
sp_pmo_day_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_PM_outbound_I5_I205)$coefficient[, 1]))

sp_did_0814_AM_outbound_I5_I205_df <- data.frame(Group=rep(c("Control", "Treated", "Counterfactual"), each=2), 
                                                Before_after=rep(c("before", "after"), 3),
                                                sp_ami_day_0814_I5_I205_speed=as.numeric(sp_ami_day_coef_mx_0814_I5_I205 %*% bm_mx),
                                                sp_pmi_day_0814_I5_I205_speed=as.numeric(sp_pmi_day_coef_mx_0814_I5_I205 %*% bm_mx),
                                                sp_amo_day_0814_I5_I205_speed=as.numeric(sp_amo_day_coef_mx_0814_I5_I205 %*% bm_mx),
                                                sp_pmo_day_0814_I5_I205_speed=as.numeric(sp_pmo_day_coef_mx_0814_I5_I205 %*% bm_mx)) 

sp_did_0814_AM_outbound_I5_I205_df$Before_after <- relevel(sp_did_0814_AM_outbound_I5_I205_df$Before_after, "before")


sp_ami_0814_I5_I205_day_speed_df <- sp_did_0814_AM_outbound_I5_I205_df %>%
  select(Group, Before_after, Speed=sp_ami_day_0814_I5_I205_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Inbound")

sp_pmi_0814_I5_I205_day_speed_df <- sp_did_0814_AM_outbound_I5_I205_df %>%
  select(Group, Before_after, Speed=sp_pmi_day_0814_I5_I205_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Inbound")

sp_amo_0814_I5_I205_day_speed_df <- sp_did_0814_AM_outbound_I5_I205_df %>%
  select(Group, Before_after, Speed=sp_amo_day_0814_I5_I205_speed) %>%
  mutate(AM_PM="AM peak",
         Direction="Outbound")

sp_pmo_0814_I5_I205_day_speed_df <- sp_did_0814_AM_outbound_I5_I205_df %>%
  select(Group, Before_after, Speed=sp_pmo_day_0814_I5_I205_speed) %>%
  mutate(AM_PM="PM peak",
         Direction="Outbound")

sp_did_0814_I5_I205_df_long <- rbind(sp_ami_0814_I5_I205_day_speed_df, sp_pmi_0814_I5_I205_day_speed_df, 
                                    sp_amo_0814_I5_I205_day_speed_df, sp_pmo_0814_I5_I205_day_speed_df)%>%
  mutate(Scenario=paste(AM_PM, Direction, sep=" "),
         Before_after=ifelse(Before_after=="after", 1, 0))

# Plot of two peak periods and two directions  
p_sp_0814_I5_I205_did_4g <-  ggplot(sp_did_0814_I5_I205_df_long, aes(x=Before_after, y=Speed, group=Group)) +
  geom_line(aes(color=Group)) + geom_point() + ylab("Speed (MPH)") + 
  xlab("Time (after=1)")  + scale_x_continuous(breaks=c(0, 1)) + 
  ggtitle("Green Line DID models for weekday peak periods speed") +  facet_grid(AM_PM ~ Direction) + 
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=8)
  ) 

p_sp_0814_I5_I205_did_4g
```


### DID Multiple time periods models 
To investigate the changes in peak periods travel speed over time, DID regression models with multiple time periods are estimated. I creat year dummies for all years (1st year: 09/12/2015 - 09/11/2016; 2nd year: 09/12/2016 - 09/11/2017; 3rd year: 09/12/2017 - 09/11/2018). The following table shows the results of the DID regression models. Of the four models, the coefficients of DID estimators indicate significant relative increase in the speed of the experiment roadway in most cases. Only the DID estimator for the first year PM peak outbound from CBD is negative, but it is not statistically significant. The results reveal that the Orange Line has had a positive impact on average peak periods travel speed on SE McLoughlin Blvd.

```{r}
##### Orange Line 
# Multiple time periods models 
sp_amo_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="AM"))

sp_ami_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="AM"))

sp_pmo_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_S", "Powell_E"), AM_PM=="PM"))

sp_pmi_day_ma_3yd_int <- lm(AvgSpeed ~  ec_group + year_1st + year_2nd + year_3rd + ec_group*year_1st + ec_group*year_2nd + ec_group*year_3rd, 
                            data=data_combined_day_wdpeak %>% filter(roadway %in% c("McLoughlin_N", "Powell_W"), AM_PM=="PM"))

stargazer(sp_amo_day_ma_3yd_int, sp_ami_day_ma_3yd_int, sp_pmo_day_ma_3yd_int, sp_pmi_day_ma_3yd_int, 
          column.labels = c("AM Outbound", "AM Inbound", "PM Outbound",  "PM Inbound"),
          dep.var.labels=c("Travel Speed"),
          type="text", title="Orange Line speed DID with multiple time priods", keep.stat=c("n", "rsq", "adj.rsq", "ser"))
```
```{r}
##### Green Line 
# Multiple time periods DID models
# Inbound 
GL_DID_0814_AM_inbound_I5_I205_mt <- lm(r_speed ~ Group + year_1st + year_2nd + year_3rd + year_4th + year_5th + 
                                          year_1st*Group + year_2nd*Group + year_3rd*Group + year_4th*Group + year_5th*Group, 
                                        data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="AM", roadway %in% c("I-5 North", "I-205 North")))

GL_DID_0814_PM_inbound_I5_I205_mt <- lm(r_speed ~ Group + year_1st + year_2nd + year_3rd + year_4th + year_5th + 
                                          year_1st*Group + year_2nd*Group + year_3rd*Group + year_4th*Group + year_5th*Group, 
                                        data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="PM", roadway %in% c("I-5 North", "I-205 North")))

# Outbound
GL_DID_0814_AM_outbound_I5_I205_mt <- lm(r_speed ~ Group + year_1st + year_2nd + year_3rd + year_4th + year_5th + 
                                           year_1st*Group + year_2nd*Group + year_3rd*Group + year_4th*Group + year_5th*Group, 
                                         data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="AM", roadway %in% c("I-5 South", "I-205 South")))

GL_DID_0814_PM_outbound_I5_I205_mt <- lm(r_speed ~ Group + year_1st + year_2nd + year_3rd + year_4th + year_5th + 
                                           year_1st*Group + year_2nd*Group + year_3rd*Group + year_4th*Group + year_5th*Group, 
                                         data=GL_DID_0814_I5_I205_I84_bd_df %>% filter(AM_PM=="PM", roadway %in% c("I-5 South", "I-205 South")))

stargazer(GL_DID_0814_AM_inbound_I5_I205_mt, GL_DID_0814_PM_inbound_I5_I205_mt,  GL_DID_0814_AM_outbound_I5_I205_mt, GL_DID_0814_PM_outbound_I5_I205_mt,
          column.labels = c("AM Inbound", "PM Inbound", "AM Outbound", "PM Outbound"),
          dep.var.labels=c("Travel Speed"),
          # covariate.labels=c("Time Period (after = 1)", "Group (experimental group = 1)", "Time Period × Group"),
          type="text", title="GL Route Travel Speed 09/12/2004-09/12/2014 & I-84 as the experimental corridor", keep.stat=c("n", "rsq", "adj.rsq", "ser"))  
```

Using the results of DID models with multiple time periods, Figure \@ref(fig:ol-sp-did-mt) shows predicted average weekday peak periods speed over time. The dashed horizontal lines indicate the average treated impacts of corresponding cases. The line plot reveals the nonlinear effect of the Orange Line on traffic. Overall, the size of the effects increased over time. The size of yearly effects is different for AM/PM peak periods and inbound to and outbound from CBD directions.

```{r ol-sp-did-mt, fig.cap="Orange Line DID multiple time periods models for weekday peak periods speed"}
##### Orange Line 
# Plot multiple time priods results 
# plot DID models with three year dummy variables 
mt_3yd_mx <- matrix(c(rep(1, 4),
                      rep(1, 4),
                      0, 1, 0, 0, 
                      0, 0, 1, 0,
                      0, 0, 0, 1,
                      0, 1, 0, 0, 
                      0, 0, 1, 0,
                      0, 0, 0, 1), nrow=8, byrow=TRUE)

# AM outbound 
sp_amo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_amo_day_ma_3yd_int)$coefficient[, 1]))
sp_amo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_amo_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_amo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_amo_day_ma_3yd_int)$coefficient[, 1]))
# ddv_amo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_amo_day_ma_3yd_int)$coefficient[, 2]))^2

amo_day_ma_3yd_int_df <- data.frame(AM_PM="AM peak",
                                   Direction="Outbound from CBD",
                                   TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                    levels=c("Before", "1st year", "2nd year", "3rd year")),
                                   Speed=as.numeric(sp_amo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   Speed_se=as.numeric(sqrt(sp_amo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                   # DDV=as.numeric(ddv_amo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   # DDV_se=as.numeric(sqrt(ddv_amo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# AM inbound 
sp_ami_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_ami_day_ma_3yd_int)$coefficient[, 1]))
sp_ami_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_ami_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_ami_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_ami_day_ma_3yd_int)$coefficient[, 1]))
# ddv_ami_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_ami_day_ma_3yd_int)$coefficient[, 2]))^2

ami_day_ma_3yd_int_df <- data.frame(AM_PM="AM peak",
                                   Direction="Inbound to CBD",
                                   TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                    levels=c("Before", "1st year", "2nd year", "3rd year")),
                                   Speed=as.numeric(sp_ami_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   Speed_se=as.numeric(sqrt(sp_ami_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                   # DDV=as.numeric(ddv_ami_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                   # DDV_se=as.numeric(sqrt(ddv_ami_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# PM outbound 
sp_pmo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_pmo_day_ma_3yd_int)$coefficient[, 1]))
sp_pmo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_pmo_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_pmo_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_pmo_day_ma_3yd_int)$coefficient[, 1]))
# ddv_pmo_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_pmo_day_ma_3yd_int)$coefficient[, 2]))^2

pmo_day_ma_3yd_int_df <- data.frame(AM_PM="PM peak",
                                    Direction="Outbound from CBD",
                                    TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                     levels=c("Before", "1st year", "2nd year", "3rd year")),
                                    Speed=as.numeric(sp_pmo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    Speed_se=as.numeric(sqrt(sp_pmo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                    # DDV=as.numeric(ddv_pmo_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    # DDV_se=as.numeric(sqrt(ddv_pmo_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

# PM inbound 
sp_pmi_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(sp_pmi_day_ma_3yd_int)$coefficient[, 1]))
sp_pmi_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(sp_pmi_day_ma_3yd_int)$coefficient[, 2]))^2

# ddv_pmi_day_ma_3yd_int_coef_mx <- t(as.matrix(summary(ddv_pmi_day_ma_3yd_int)$coefficient[, 1]))
# ddv_pmi_day_ma_3yd_int_sesq_mx <- t(as.matrix(summary(ddv_pmi_day_ma_3yd_int)$coefficient[, 2]))^2

pmi_day_ma_3yd_int_df <- data.frame(AM_PM="PM peak",
                                    Direction="Inbound to CBD",
                                    TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year"), ordered = TRUE, 
                                                     levels=c("Before", "1st year", "2nd year", "3rd year")),
                                    Speed=as.numeric(sp_pmi_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    Speed_se=as.numeric(sqrt(sp_pmi_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) #,
                                    # DDV=as.numeric(ddv_pmi_day_ma_3yd_int_coef_mx %*% mt_3yd_mx),
                                    # DDV_se=as.numeric(sqrt(ddv_pmi_day_ma_3yd_int_sesq_mx %*% mt_3yd_mx))) 

did_day_ma_3yd_int_df <- rbind(amo_day_ma_3yd_int_df, ami_day_ma_3yd_int_df, pmo_day_ma_3yd_int_df, pmi_day_ma_3yd_int_df)%>%
                         mutate(Group=paste(AM_PM, Direction, sep=" "))

# Plot of two peak periods and two directions
p_sp_did_ma_3yd_int_4g <-  ggplot(did_day_ma_3yd_int_df, aes(x=TreatTime, y=Speed, group=Group, color=Group)) +
  geom_line() + geom_point() + 
  geom_errorbar(aes(ymin=Speed-1.96*Speed_se, ymax=Speed+1.96*Speed_se, width=.1)) + # , position=position_dodge(0.05)
  geom_hline(yintercept = c(26.9, 35.6, 34.4, 28.0), color=c('#999999','#E69F00', "#82E0AA", "#85C1E9"), linetype="dashed")+
  xlab("Treatment time periods") + ylab("Speed (MPH)") + ylim(20, 40) +
  ggtitle("Orange Line Predicted average weekday peak periods speed") + scale_color_manual(values=c('#999999','#E69F00', "#82E0AA", "#85C1E9")) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=8)
  ) + guides(colour =guide_legend(ncol=2))

p_sp_did_ma_3yd_int_4g

ggsave(file="output/plots/OL DID plots/p_sp_did_ma_3yd_int_4g.png", p_sp_did_ma_3yd_int_4g, width=5, heigh=4)
```

Figure \@ref(fig:gl-sp-did-mt)
```{r gl-sp-did-mt, fig.cap="Green Line DID multiple time periods models for weekday peak periods speed"}
##### Green Line 
# Using I-84 as the experimental corridor 
mt_5yd_mx <- matrix(c(rep(1, 6),
                      rep(1, 6),
                      0, 1, 0, 0, 0, 0,
                      0, 0, 1, 0, 0, 0,
                      0, 0, 0, 1, 0, 0,
                      0, 0, 0, 0, 1, 0,
                      0, 0, 0, 0, 0, 1,
                      
                      0, 1, 0, 0, 0, 0,
                      0, 0, 1, 0, 0, 0,
                      0, 0, 0, 1, 0, 0,
                      0, 0, 0, 0, 1, 0,
                      0, 0, 0, 0, 0, 1), nrow=12, byrow=TRUE)

gl_sp_ami_did_mt_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_AM_inbound_I5_I205_mt)$coefficient[, 1]))
gl_sp_pmi_did_mt_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_PM_inbound_I5_I205_mt)$coefficient[, 1]))

gl_sp_amo_did_mt_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_AM_outbound_I5_I205_mt)$coefficient[, 1]))
gl_sp_pmo_did_mt_coef_mx_0814_I5_I205 <- t(as.matrix(summary(GL_DID_0814_PM_outbound_I5_I205_mt)$coefficient[, 1]))


gl_sp_ami_did_mt_df_0814_I5_I205 <- data.frame(AM_PM="AM peak",
                                         Direction="Inbound",
                                         TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year"), ordered = TRUE, 
                                                          levels=c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year")),
                                         Speed=as.numeric(gl_sp_ami_did_mt_coef_mx_0814_I5_I205 %*% mt_5yd_mx))

gl_sp_pmi_did_mt_df_0814_I5_I205 <- data.frame(AM_PM="PM peak",
                                         Direction="Inbound",
                                         TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year"), ordered = TRUE, 
                                                          levels=c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year")),
                                         Speed=as.numeric(gl_sp_pmi_did_mt_coef_mx_0814_I5_I205 %*% mt_5yd_mx))

gl_sp_amo_did_mt_df_0814_I5_I205 <- data.frame(AM_PM="AM peak",
                                         Direction="Outbound",
                                         TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year"), ordered = TRUE, 
                                                          levels=c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year")),
                                         Speed=as.numeric(gl_sp_amo_did_mt_coef_mx_0814_I5_I205 %*% mt_5yd_mx))

gl_sp_pmo_did_mt_df_0814_I5_I205 <- data.frame(AM_PM="PM peak",
                                         Direction="Outbound",
                                         TreatTime=factor(c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year"), ordered = TRUE, 
                                                          levels=c("Before", "1st year", "2nd year", "3rd year", "4th year", "5th year")),
                                         Speed=as.numeric(gl_sp_pmo_did_mt_coef_mx_0814_I5_I205 %*% mt_5yd_mx))

gl_sp_did_5yd_df_long_0814_I5_I205 <- rbind(gl_sp_ami_did_mt_df_0814_I5_I205, gl_sp_pmi_did_mt_df_0814_I5_I205,
                                           gl_sp_amo_did_mt_df_0814_I5_I205, gl_sp_pmo_did_mt_df_0814_I5_I205) %>%
                                     mutate(Group=paste(AM_PM, Direction, sep=" "))


gl_p_0814_I5_I205_sp_did_5yd_int_4g <-  ggplot(gl_sp_did_5yd_df_long_0814_I5_I205, aes(x=TreatTime, y=Speed, group=Group, color=Group)) +
  geom_line() + geom_point() + 
  # geom_errorbar(aes(ymin=Speed-1.96*Speed_se, ymax=Speed+1.96*Speed_se, width=.1)) + # , position=position_dodge(0.05)
  # geom_hline(yintercept = c(57.3, 54.1, 73.6, 54.5), color=c('#999999','#E69F00', "#82E0AA", "#85C1E9"), linetype="dashed")+
  xlab("Treatment time periods") + ylab("Speed (MPH)") + # ylim(40, 70) +
  ggtitle("Green Line Predicted average weekday peak periods speed") + scale_color_manual(values=c('#999999','#E69F00', "#82E0AA", "#85C1E9")) +
  theme(plot.title = element_text(family="Times",hjust = 0.5, size=12, face="bold"),
        axis.text = element_text(family="Times",size=8),
        axis.title=element_text(family="Times",size=9),
        legend.position="bottom",
        legend.title=element_text(family="Times",size=9, face="bold"),
        legend.text=element_text(family="Times",size=8)
  ) + guides(colour =guide_legend(ncol=2))

gl_p_0814_I5_I205_sp_did_5yd_int_4g
```








